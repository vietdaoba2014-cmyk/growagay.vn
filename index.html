<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grow a Gay by Việt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/p5.min.js"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        @keyframes naturalSway {
            0%, 100% { transform: rotate(-1deg) translateX(-1px); }
            33% { transform: rotate(1deg) translateX(1px); }
            66% { transform: rotate(-0.5deg) translateX(0px); }
        }
        @keyframes gentlePulse {
            0%, 100% { transform: scale(1) rotate(var(--rotation, 0deg)); }
            50% { transform: scale(1.02) rotate(var(--rotation, 0deg)); }
        }
        @keyframes readyGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
        }
        @keyframes frozenGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); }
            50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.7); }
        }
        @keyframes goldenGlow {
            0%, 100% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.6); }
            50% { box-shadow: 0 0 40px rgba(255, 215, 0.9); }
        }
        @keyframes rainbowGlow {
            0% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
            20% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.5); }
            40% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.5); }
            60% { box-shadow: 0 0 20px rgba(0, 0, 255, 0.5); }
            80% { box-shadow: 0 0 20px rgba(128, 0, 128, 0.5); }
            100% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
        }
        @keyframes nightGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(75, 85, 99, 0.5); }
            50% { box-shadow: 0 0 30px rgba(75, 85, 99, 0.8); }
        }
        @keyframes thunderGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 255, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 255, 255, 0.8); }
        }
        @keyframes tungGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 69, 19, 0.5); }
            50% { box-shadow: 0 0 30px rgba(139, 69, 19, 0.8); }
        }
        @keyframes zombieGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 128, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(0, 128, 0, 0.8); }
        }
        @keyframes owlGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(128, 0, 128, 0.5); }
            50% { box-shadow: 0 0 30px rgba(128, 0, 128, 0.8); }
        }
        @keyframes chocolateGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 69, 19, 0.5); }
            50% { box-shadow: 0 0 30px rgba(139, 69, 19, 0.8); }
        }
        /* New animations for requested effects */
        @keyframes meteorShowerGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 100, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 100, 0, 0.8); }
        }
        @keyframes alienLikeGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(0, 255, 0, 0.8); }
        }
        @keyframes blackholeGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 0, 0, 0.8); }
            50% { box-shadow: 0 0 40px rgba(0, 0, 0, 1); }
        }
        @keyframes superHarvestGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 255, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 255, 0, 0.8); }
        }
        @keyframes evolutionGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(147, 51, 234, 0.5); }
            50% { box-shadow: 0 0 40px rgba(147, 51, 234, 1); }
        }


        .plant-grow {
            animation: naturalSway 4s ease-in-out infinite, gentlePulse 3s ease-in-out infinite;
        }
        .plant-ready {
            animation: naturalSway 3s ease-in-out infinite, readyGlow 2s ease-in-out infinite;
        }
        .plant-frozen {
            animation: naturalSway 6s ease-in-out infinite, frozenGlow 2s ease-in-out infinite;
            filter: brightness(0.8) contrast(1.2) hue-rotate(180deg);
        }
        .plant-golden {
            animation: naturalSway 2s ease-in-out infinite, goldenGlow 1s ease-in-out infinite;
            filter: brightness(1.5) saturate(1.8) hue-rotate(20deg);
        }
        .plant-pest {
            filter: brightness(0.7) saturate(0.5);
        }
        .plant-giant {
            transform: scale(1.2);
        }
        .plant-rainbow {
            animation: naturalSway 2s ease-in-out infinite, rainbowGlow 3s ease-in-out infinite;
            filter: brightness(1.3) saturate(2);
        }
        .plant-night {
            animation: naturalSway 3s ease-in-out infinite, nightGlow 2s ease-in-out infinite;
            filter: brightness(0.9) contrast(1.3) hue-rotate(270deg);
        }
        .plant-thunder {
            animation: naturalSway 2s ease-in-out infinite, thunderGlow 1s ease-in-out infinite;
            filter: brightness(1.2) saturate(1.5);
        }
        .plant-tung {
            animation: naturalSway 2.5s ease-in-out infinite, tungGlow 1.5s ease-in-out infinite;
            filter: brightness(1.1) saturate(1.5) hue-rotate(30deg);
        }
        .plant-zombie {
            animation: naturalSway 3s ease-in-out infinite, zombieGlow 2s ease-in-out infinite;
            filter: brightness(0.9) contrast(1.2) hue-rotate(90deg);
        }
        .plant-owl {
            animation: naturalSway 3s ease-in-out infinite, owlGlow 2s ease-in-out infinite;
            filter: brightness(0.9) contrast(1.2) hue-rotate(200deg);
        }
        .plant-chocolate {
            animation: naturalSway 3s ease-in-out infinite, chocolateGlow 2s ease-in-out infinite;
            filter: brightness(1.1) saturate(1.5) hue-rotate(10deg);
        }
        /* New classes for requested effects */
        .plant-meteorShower {
            animation: naturalSway 3s ease-in-out infinite, meteorShowerGlow 2s ease-in-out infinite;
            filter: brightness(1.2) saturate(1.5) hue-rotate(-20deg);
        }
        .plant-alienLike {
            animation: naturalSway 3.5s ease-in-out infinite, alienLikeGlow 2.5s ease-in-out infinite;
            filter: brightness(1.1) contrast(1.3) hue-rotate(100deg);
        }
        .plant-blackhole {
            animation: naturalSway 2s ease-in-out infinite, blackholeGlow 1.5s ease-in-out infinite;
            filter: brightness(0.5) contrast(2);
            transform: scale(0.9); /* Make it slightly smaller to imply compression */
        }
        .plant-superHarvest {
            animation: naturalSway 2s ease-in-out infinite, superHarvestGlow 1.5s ease-in-out infinite;
            filter: brightness(1.5) saturate(1.8);
        }
        
        /* Evolution ready state */
        .pet-evolution-ready {
            animation: naturalSway 2s ease-in-out infinite, evolutionGlow 2s ease-in-out infinite !important;
            filter: brightness(1.3) contrast(1.2);
        }

        /* Cooldown timer display */
        .cooldown-timer {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 10px;
            padding: 2px 4px;
            border-radius: 8px;
            z-index: 10;
        }

        .canvas-container {
            display: none;
            position: relative;
            width: 400px;
            height: 400px;
            margin: 0 auto;
            background: transparent;
            padding: 0;
            border-radius: 0;
        }
        .canvas-container.active {
            display: block;
        }
        .modal-bg {
            background: rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-100 via-blue-50 to-purple-100 p-4">
    <!-- Login/Register Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl animate-pulse" id="auth-form">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center" id="auth-title">Đăng Nhập</h2>
            <div class="mb-4">
                <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Tên người dùng:</label>
                <input type="text" id="username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" maxlength="14" onkeypress="handleKeyPress(event, currentAuthMode)">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Mật khẩu:</label>
                <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" maxlength="14" onkeypress="handleKeyPress(event, currentAuthMode)">
            </div>
            <div class="flex items-center justify-between">
                <button onclick="handleAuth('login')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" id="login-button">Đăng Nhập</button>
                <button onclick="handleAuth('register')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" id="register-button">Đăng Ký</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <!-- Spin Wheel Modal -->
        <div id="spin-wheel-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl animate-pulse">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Vòng Quay May Mắn</h2>
                <p class="text-gray-600 mb-4 text-center">Quay để nhận thưởng!</p>
                <div id="wheel-canvas-container" class="canvas-container"></div>
                <div id="spin-result" class="text-center text-lg font-semibold text-green-600 mb-4"></div>
                <button onclick="spinWheel()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">Quay</button>
            </div>
        </div>

        <!-- Snake Minigame Modal -->
        <div id="snake-game-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Minigame Rắn Săn Mồi</h2>
                <p class="text-gray-600 mb-4 text-center">Sống sót 30 giây và ăn 8 điểm để nhận thưởng!</p>
                <div id="snake-game-timer" class="text-center text-lg font-semibold text-blue-600 mb-4">30s</div>
                <div id="snake-game-score" class="text-center text-lg font-semibold text-blue-600 mb-4">Điểm: 0</div>
                <div id="snake-canvas-container" class="canvas-container"></div>
                <button onclick="startSnakeGame()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200 mt-4">Bắt Đầu</button>
            </div>
        </div>

        <!-- Sell Confirmation Modal -->
        <div id="sell-confirm-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl animate-pulse">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Ông Bán Hàng Định Giá</h2>
                    <p id="sell-crop-info" class="text-lg text-gray-600"></p>
                    <p id="sell-price" class="text-xl font-semibold text-green-600 mt-2"></p>
                </div>
                <div class="flex gap-4 justify-center">
                    <button onclick="confirmSell()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">Bán</button>
                    <button onclick="cancelSell()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">Hủy</button>
                </div>
            </div>
        </div>

        <!-- News Poll Modal -->
        <div id="news-poll-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl animate-pulse">
                <div class="text-center mb-6">
                    <h2 id="poll-title" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                    <p id="poll-question" class="text-lg text-gray-600"></p>
                    <p id="poll-money" class="text-sm text-red-500 mt-2 hidden"></p>
                </div>
                <div id="poll-options" class="space-y-3"></div>
                <div id="poll-reward" class="mt-4 text-center text-sm text-gray-500"></div>
            </div>
        </div>

        <!-- Pet Upgrade Modal -->
        <div id="pet-upgrade-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl animate-pulse">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Nâng Cấp Thú Cưng</h2>
                <p id="upgrade-pet-info" class="text-gray-600 mb-4 text-center"></p>
                <p class="text-gray-600 mb-4 text-center">Chi phí: 500,000,000$ và 1 Cây Xương Ai Cập</p>
                <div class="flex gap-4 justify-center">
                    <button onclick="confirmUpgradePet()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">Nâng Cấp</button>
                    <button onclick="cancelUpgradePet()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">Hủy</button>
                </div>
            </div>
        </div>

        <!-- Evolution Confirmation Modal -->
        <div id="evolution-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl animate-pulse">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">🌟 Tiến Hóa Thú Cưng 🌟</h2>
                    <p id="evolution-pet-info" class="text-lg text-gray-600"></p>
                    <p class="text-sm text-purple-600 mt-2">Thú cưng sẽ mạnh hơn và mở khóa slot vườn mới!</p>
                </div>
                <div class="flex gap-4 justify-center">
                    <button onclick="confirmEvolution()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">Tiến Hóa</button>
                    <button onclick="cancelEvolution()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">Để Sau</button>
                </div>
            </div>
        </div>

        <!-- Egg Open Modal -->
        <div id="egg-open-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl animate-pulse">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Mở Trứng</h2>
                <p id="egg-open-info" class="text-gray-600 mb-4 text-center"></p>
                <p id="egg-open-timer" class="text-xl font-semibold text-blue-600 mb-4 text-center"></p>
                <div class="flex gap-4 justify-center">
                    <button onclick="openEgg()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200" id="open-egg-button" disabled>Mở Ngay</button>
                    <button onclick="cancelEggOpen()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">Hủy</button>
                </div>
            </div>
        </div>

        <!-- Ancient Quest Modal -->
        <div id="ancient-quest-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl animate-pulse">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Nhiệm Vụ Cổ Đại</h2>
                <p class="text-gray-600 mb-4 text-center">Hoàn thành các nhiệm vụ sau để nhận rương cổ đại!</p>
                <ul id="ancient-quest-list" class="list-disc list-inside text-gray-700 mb-6">
                    <li>Trồng một Cây Xương Saundice và đạt trên 12kg: <span id="ancient-quest-1" class="font-semibold">❌</span></li>
                    <li>Trồng một Cây Xương Saundice và giá trị của nó trên 2650 tiền: <span id="ancient-quest-2" class="font-semibold">❌</span></li>
                    <li>Sở hữu 50,000,000$: <span id="ancient-quest-3" class="font-semibold">❌</span></li>
                </ul>
                <button onclick="closeAncientQuestModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200 w-full">Đóng</button>
            </div>
        </div>

        <!-- Ancient Chest Modal -->
        <div id="ancient-chest-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl animate-pulse">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Rương Cổ Đại</h2>
                <p id="ancient-chest-info" class="text-gray-600 mb-4 text-center">Bạn đã hoàn thành tất cả nhiệm vụ! Mở rương để nhận thưởng!</p>
                <p id="ancient-chest-timer" class="text-xl font-semibold text-blue-600 mb-4 text-center"></p>
                <div class="flex gap-4 justify-center">
                    <button onclick="openAncientChest()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200" id="open-ancient-chest-button" disabled>Mở Rương</button>
                    <button onclick="closeAncientChestModal()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">Hủy</button>
                </div>
            </div>
        </div>

        <!-- Summer Carrot Quest Modal -->
        <div id="summer-carrot-quest-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl animate-pulse">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Nhiệm Vụ Cà Rốt Mùa Hè</h2>
                <p class="text-gray-600 mb-4 text-center">Hoàn thành các nhiệm vụ sau để nhận thưởng!</p>
                <ul id="summer-carrot-quest-list" class="list-disc list-inside text-gray-700 mb-6">
                    <li>Mua 25 Cà rốt: <span id="summer-carrot-quest-1" class="font-semibold">❌</span></li>
                    <li>Thu hoạch 25 Cà rốt: <span id="summer-carrot-quest-2" class="font-semibold">❌</span></li>
                    <li>Sở hữu 1 Cà rốt vàng: <span id="summer-carrot-quest-3" class="font-semibold">❌</span></li>
                </ul>
                <button onclick="closeSummerCarrotQuestModal()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200 w-full">Đóng</button>
            </div>
        </div>

        <!-- Player List Modal (Modified for Garden Viewing) -->
        <div id="player-list-modal" class="fixed inset-0 hidden items-center justify-center modal-bg z-50">
            <div class="bg-white rounded-xl p-6 w-96 max-h-[80vh] overflow-y-auto shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-center">Danh sách người chơi</h2>
                <ul id="player-list" class="divide-y divide-gray-300 max-h-64 overflow-y-auto mb-4"></ul>
                <button onclick="closePlayerList()" class="bg-red-600 text-white px-4 py-2 rounded w-full hover:bg-red-700">Đóng</button>
            </div>
        </div>

        <!-- Pet Details Modal -->
        <div id="pet-details-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
                <h2 id="pet-name" class="text-2xl font-bold text-gray-800 mb-4 text-center"></h2>
                <div id="pet-info" class="text-gray-600 mb-4 space-y-2"></div>
                <div id="pet-function" class="text-sm text-blue-600 mb-4 p-3 bg-blue-50 rounded-lg"></div>
                <div id="pet-next-skill" class="text-xs text-orange-600 mb-4"></div>
                <div class="flex gap-2 justify-center">
                    <button onclick="sellSelectedPet()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-200">Bán</button>
                    <button onclick="removePetToInventory()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-200">Gỡ ra</button>
                    <button onclick="closePetDetails()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-xl font-semibold transition-all duration-200">Hủy</button>
                </div>
            </div>
        </div>

        <!-- Chat Modal (New) -->
        <div id="chat-modal" class="fixed inset-0 hidden items-center justify-center modal-bg z-50">
            <div class="bg-white rounded-xl p-6 w-96 shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-center">Trò chuyện</h2>
                <div id="chat-messages" class="h-64 overflow-y-auto border border-gray-300 p-2 rounded mb-4"></div>
                <input type="text" id="chat-input" placeholder="Nhập tin nhắn..." class="w-full p-2 border rounded mb-2">
                <button onclick="sendMessage()" class="bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700 mb-2">Gửi</button>
                <button onclick="closeChat()" class="bg-gray-600 text-white px-4 py-2 rounded w-full hover:bg-gray-700">Đóng</button>
            </div>
        </div>

        <!-- Notifications -->
        <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-6xl font-bold bg-gradient-to-r from-green-600 via-blue-600 to-purple-600 bg-clip-text text-transparent mb-4">
                🌱 Gay Garden 🌱
            </h1>
            <div class="flex justify-center items-center gap-8 text-2xl font-semibold">
                <div class="flex items-center gap-2 bg-yellow-100 px-6 py-3 rounded-full shadow-lg">
                    <span class="text-yellow-600">💰</span>
                    <span id="money" class="text-yellow-800">100$</span>
                </div>
                <div class="flex items-center gap-2 bg-blue-100 px-6 py-3 rounded-full shadow-lg">
                    <span class="text-blue-600">⏰</span>
                    <span id="shop-timer" class="text-blue-800">Shop: 10s</span>
                </div>
                <div class="flex items-center gap-2 bg-pink-100 px-6 py-3 rounded-full shadow-lg">
                    <span class="text-pink-600">🐾</span>
                    <span id="pet-shop-timer" class="text-pink-800">Pet Shop: 20s</span>
                </div>
                <div class="flex items-center gap-2 bg-purple-100 px-6 py-3 rounded-full shadow-lg">
                    <span class="text-purple-600">🎡</span>
                    <span id="seed-progress" class="text-purple-800">Vòng Quay: 35s</span>
                </div>
                <div class="flex items-center gap-2 bg-green-100 px-6 py-3 rounded-full shadow-lg">
                    <span class="text-green-600">💧</span>
                    <span id="item-shop-timer" class="text-green-800">Item Shop: 30s</span>
                </div>
            </div>
            <div class="mt-4">
                <input type="text" id="command-input" placeholder="Nhập lệnh..." class="p-2 rounded-md border border-gray-300">
                <button onclick="executeCommand()" class="ml-2 bg-blue-500 text-white p-2 rounded-md">Thực hiện</button>
                <button onclick="showPlayerList()" class="ml-2 bg-gray-500 text-white p-2 rounded-md">⚙️ Cài đặt</button>
                <button onclick="openChat()" class="ml-2 bg-blue-500 text-white p-2 rounded-md">💬 Trò chuyện</button>
            </div>
        </div>

        <!-- Current Event -->
        <!-- Modified to include quest details directly -->
        <div id="current-event" class="hidden mb-6 p-4 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl shadow-lg border-2 border-purple-200 cursor-pointer" onclick="openEventQuestModal()">
            <div class="flex items-center gap-3">
                <span id="event-icon" class="text-3xl"></span>
                <div class="text-left">
                    <h3 id="event-name" class="text-xl font-bold text-purple-800"></h3>
                    <p id="event-description" class="text-purple-600"></p>
                    <p id="event-timer" class="text-sm text-purple-500"></p>
                    <div id="event-quest-details" class="mt-2 text-gray-700 text-sm">
                        <!-- Quest details will be injected here -->
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- IU Shop & Pet Shop & Item Shop -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl p-6 border border-purple-200">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="text-purple-600 text-2xl">🛒</span>
                        <h2 class="text-3xl font-bold text-purple-800" id="shop-title">IU Shop</h2>
                    </div>
                    <div id="shop-items" class="space-y-4 max-h-96 overflow-y-auto"></div>
                </div>
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl p-6 border border-pink-200">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="text-pink-600 text-2xl">🐾</span>
                        <h2 class="text-3xl font-bold text-pink-800">Pet Shop</h2>
                    </div>
                    <div id="pet-shop-items" class="space-y-4 max-h-96 overflow-y-auto"></div>
                </div>
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl p-6 border border-green-200">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="text-green-600 text-2xl">💧</span>
                        <h2 class="text-3xl font-bold text-green-800">Item Shop</h2>
                    </div>
                    <div id="item-shop-items" class="space-y-4 max-h-96 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Garden & Inventory -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl p-6 border border-green-200">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-green-600 text-2xl">🌿</span>
                        <h2 class="text-3xl font-bold text-green-800">Kho Hạt Giống & Thú Cưng & Vật Phẩm</h2>
                    </div>
                    <div id="inventory-items" class="grid grid-cols-2 md:grid-cols-5 gap-3"></div>
                </div>

                <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-2xl p-6 border border-yellow-200">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-yellow-600 text-2xl">☀️</span>
                        <h2 class="text-3xl font-bold text-yellow-800">Vườn Trồng</h2>
                    </div>
                    <div id="pet-garden" class="grid grid-cols-2 gap-4 mb-4 min-h-[100px]"></div>
                    <div id="crop-garden" class="grid grid-cols-3 md:grid-cols-5 gap-4 min-h-[400px]"></div>
                    <div class="mt-6 text-center text-gray-600">
                        <p class="text-lg">💡 <strong>Hướng dẫn:</strong></p>
                        <p>Mua hạt giống/thú cưng/vật phẩm → Trồng từ kho → Kéo cây chín hoặc thú cưng đến ông bán hàng để định giá và bán!</p>
                        <p>Chơi minigame Rắn Săn Mồi để nhận thưởng xịn!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const crops = [
            { name: 'Cà rốt', price: 20, sellRate: 0.8, minYield: 1, maxYield: 7, multiplier: 1.1, icon: '🥕', color: 'orange' },
            { name: 'Khoai lang', price: 35, sellRate: 0.8, minYield: 2, maxYield: 6, multiplier: 1.4, icon: '🍠', color: 'amber' },
            { name: 'Cây chuối', price: 200, sellRate: 0.6, minYield: 4, maxYield: 9, multiplier: 4, icon: '🍌', color: 'yellow' },
            { name: 'Cây dưa hấu', price: 399, sellRate: 0.5, minYield: 11, maxYield: 19, multiplier: 3.5, icon: '🍉', color: 'emerald' },
            { name: 'Cây xoài', price: 450, sellRate: 0.45, minYield: 8, maxYield: 14, multiplier: 7, icon: '🥭', color: 'green' },
            { name: 'Cây nho', price: 699, sellRate: 0.41, minYield: 6, maxYield: 14, multiplier: 9, icon: '🍇', color: 'purple' },
            { name: 'Cây Lê', price: 800, sellRate: 0.3, minYield: 5, maxYield: 12, multiplier: 16, icon: '🍐', color: 'green' },
            { name: 'Cây mít', price: 950, sellRate: 0.35, minYield: 10, maxYield: 17, multiplier: 12, icon: '🍈', color: 'lime' },
            { name: 'Cây dứa', price: 1250, sellRate: 0.3, minYield: 7, maxYield: 15, multiplier: 19, icon: '🍍', color: 'lime' },
            { name: 'Cây nấm', price: 1500, sellRate: 0.25, minYield: 18, maxYield: 25, multiplier: 14.5, icon: '🍄', color: 'pink' },
            { name: 'Cây Xương Rồng', price: 2100, sellRate: 0.2, minYield: 24, maxYield: 29, multiplier: 21, icon: '🌵', color: 'green' },
            { name: 'Cây socola', price: 3000, sellRate: 0.1, minYield: 4, maxYield: 19, multiplier: 30, icon: '🍫', color: 'brown' },
            { name: 'Cây tình yêu', price: 4550, sellRate: 0.13, minYield: 4, maxYield: 9, multiplier: 70, icon: '💝', color: 'pink' },
            { name: 'Cây candy', price: 6999, sellRate: 0.05, minYield: 12, maxYield: 30, multiplier: 48, icon: '🍭', color: 'pink' },
            { name: 'Cây đậu thần', price: 10000, sellRate: 0.025, minYield: 10, maxYield: 45, multiplier: 75, icon: '🌱', color: 'emerald' },
            { name: 'Cây Gay', price: 25000, sellRate: 0.01, minYield: 42, maxYield: 90, multiplier: 55, icon: '🏳️‍🌈', color: 'purple' },
            { name: 'Cây Xương Ai Cập', price: 100000, sellRate: 0.005, minYield: 20, maxYield: 99, multiplier: 1000, icon: '🦴', color: 'brown' },
            { name: 'Cây Bí Ngô', price: 950, sellRate: 0.35, minYield: 10, maxYield: 20, multiplier: 19, icon: '🎃', color: 'orange', nightOnly: true },
            { name: 'Cây Hướng Dương', price: 3800, sellRate: 0.2, minYield: 20, maxYield: 45, multiplier: 39, icon: '🌻', color: 'yellow', nightOnly: true },
            { name: 'Cây Ớt xanh', price: 6700, sellRate: 0.2, minYield: 5, maxYield: 15, multiplier: 99, icon: '🌶💙', color: 'yellow', nightOnly: true },
            { name: 'Cây Xoài Đêm', price: 9000, sellRate: 0.15, minYield: 8, maxYield: 16, multiplier: 50, icon: '🥭', color: 'purple', nightOnly: true },
            { name: 'Cây Cacao', price: 27000, sellRate: 0.1, minYield: 8, maxYield: 15, multiplier: 65, icon: '🍫', color: 'brown', nightOnly: true },
            { name: 'Cây Ăn Thịt', price: 50000, sellRate: 0.05, minYield: 10, maxYield: 25, multiplier: 105, icon: '🌿', color: 'red', nightOnly: true },
            { name: 'Cây Lan Hồ Điệp', price: 750000, sellRate: 0.03, minYield: 3, maxYield: 8, multiplier: 180, icon: '🌺', color: 'purple', nightOnly: true },
            { name: 'Cây ATM', price: 1500000, sellRate: 0.01, minYield: 20, maxYield: 50, multiplier: 600, icon: '💸', color: 'green', nightOnly: true },
            { name: 'Cây Trăng Khuyết', price: 4500000, sellRate: 0.005, minYield: 50, maxYield: 100, multiplier: 899, icon: '🌙', color: 'blue', nightOnly: true },
            { name: 'Cây Táo Xanh', price: 15000, sellRate: 0.02, minYield: 10, maxYield: 25, multiplier: 80, icon: '🍏', color: 'green' },
            { name: 'Cây Hoa Anh Đào', price: 30000, sellRate: 0.005, minYield: 5, maxYield: 15, multiplier: 150, icon: '🌸', color: 'pink' },
            { name: 'Cây Cứt', price: 50000, sellRate: 0.006, minYield: 1, maxYield: 15, multiplier: 999, icon: '💩', color: 'brown', effect: 'discount' },
            { name: 'Pizza', price: 50000, sellRate: 0.001, minYield: 2, maxYield: 3, multiplier: 20000, icon: '🍕', color: 'orange', effect: 'patriot' },
            { name: 'Cây Xương Đêm Đen', price: 0, sellRate: 0, minYield: 25, maxYield: 90, multiplier: 1100, icon: '🦴🌙', color: 'gray', nightOnly: true }, // Original ancient event crop
            { name: 'Cây Xương Saundice', price: 0, sellRate: 0, minYield: 5, maxYield: 45, multiplier: 1045, icon: '🦴✨', color: 'gold', nightOnly: true } // New crop for ancient event
        ];

        const pets = [
            { name: 'Chó', price: 2000, sellRate: 0.7, multiplier: 10, icon: '🐶', color: 'yellow', effect: 'seed' },
            { name: 'Mèo', price: 4000, sellRate: 0.5, multiplier: 15, icon: '😺', color: 'orange', effect: 'growth' },
            { name: 'Khỉ', price: 7500, sellRate: 0.35, multiplier: 20, icon: '🐒', color: 'brown', effect: 'sellBoost', upgrade: { name: 'Khỉ v2', multiplier: 3, cost: 500000000, item: 'Cây Xương Ai Cập' } },
            { name: 'Bướm Bướm', price: 15000, sellRate: 0.2, multiplier: 30, icon: '🦋', color: 'purple', effect: 'golden' },
            { name: 'Rồng', price: 25000, sellRate: 0.05, multiplier: 50, icon: '🐉', color: 'red', effect: 'money', upgrade: { name: 'Rồng v2', minMoney: 25000, maxMoney: 60000, cost: 500000000, item: 'Cây Xương Ai Cập' } },
            { name: 'Voi Mamut', price: 30000, sellRate: 0.03, multiplier: 60, icon: '🦣', color: 'gray', effect: 'doubleYield', upgrade: { name: 'Voi Mamut v2', multiplier: 5, cost: 500000000, item: 'Cây Xương Ai Cập' } },
            { name: 'Tralala!', price: 51000, sellRate: 0.1, multiplier: 40, icon: '🦈', color: 'blue', effect: 'rainbow' },
            { name: 'Tung Tung Sahur', price: 10000, sellRate: 0.1, multiplier: 25, icon: '🌳', color: 'brown', effect: 'tung' },
            { name: 'Ếch', price: 40000, sellRate: 0.1, multiplier: 40, icon: '🐸', color: 'green', effect: 'pestProtect' },
            { name: 'Dơi', price: 20000, sellRate: 0.1, multiplier: 30, icon: '🦇', color: 'purple', effect: 'seedClone' },
            { name: 'Cá Sấu', price: 45000, sellRate: 0.05, multiplier: 50, icon: '🐊', color: 'green', effect: 'zombieProtect' },
            { name: 'Khủng Long', price: 100000, sellRate: 0.02, multiplier: 70, icon: '🦖', color: 'lime', effect: 'petSpawn' },
            { name: 'Cú', price: 60000, sellRate: 0.03, multiplier: 55, icon: '🦉', color: 'purple', effect: 'nightOwl' },
            { name: 'Zombie Kid', price: 70000, sellRate: 0.02, multiplier: 65, icon: '🧟‍♂️', color: 'green', effect: 'zombieKid' },
            { name: 'Squid', price: 120000, sellRate: 0.01, multiplier: 80, icon: '🦑', color: 'blue', effect: 'squid' },
            { name: 'T-Rex', price: 0, sellRate: 0, multiplier: 0, icon: '🦖', color: 'lime', effect: 'tRex' }, // New pet for ancient event
            { name: 'Khủng Long 3 Sừng', price: 0, sellRate: 0, multiplier: 0, icon: '🦕', color: 'green', effect: 'triHornDino' }, // New pet for ancient event
            { name: 'Heo Cà Rốt', price: 0, sellRate: 0, multiplier: 0, icon: '🐷🥕', color: 'orange', effect: 'carrotPig' }, // New pet for summer carrot event
            { name: 'Chuột Xám', price: 0, sellRate: 0.1, multiplier: 0, icon: '🐭', color: 'gray', effect: 'grayMouse' }, // New pet from rare eggs - gives 0.5 exp/s to all pets
            { name: 'Chuột Hamster', price: 0, sellRate: 0.12, multiplier: 0, icon: '🐹', color: 'brown', effect: 'hamster' }, // New pet from legendary eggs - gives 1 exp/s to all pets
            { name: 'Chuột Sakura', price: 0, sellRate: 0.1, multiplier: 0, icon: '🐭🌸', color: 'pink', effect: 'sakuraMouse' } // New rare pet - spits saliva every 30 seconds
        ];

        const items = [
            { name: 'Vòi phun nước cấp 1', price: 500000000, sellRate: 0.1, icon: '💧', color: 'blue', effect: 'waterSpray1', description: '20% chance for +1/+2 kg yield, possible same effect' },
            { name: 'Vòi phun nước cấp 2', price: 1000000000, sellRate: 0.05, icon: '💦', color: 'cyan', effect: 'waterSpray2', description: '25% chance for +2-5 kg yield, possible same effect' },
            { name: 'Vòi phun nước cấp 3', price: 3000000000, sellRate: 0.01, icon: '🚿', color: 'indigo', effect: 'waterSpray3', description: '25% chance for x1.5 kg yield, possible same effect' },
            { name: 'Vòi phun nước Chocolate', price: 500000000, sellRate: 0.1, icon: '🍫💧', color: 'brown', effect: 'chocolateSpray', description: 'Cây to ra x1.5 (30%), nhiễm Chocolate x4 (20%)' },
            { name: 'Super Growth Big Tree Spray', price: 0, sellRate: 0.0, icon: '🌟💧', color: 'rainbow', effect: 'superGrowthSpray', description: 'Tăng 30% x 30% kg cho cây, 100% hiệu quả trên cây Super Growth event' },
            { name: 'Trứng Thường', price: 5000, sellRate: 0.8, icon: '🥚', color: 'gray', effect: 'commonEgg', description: 'Nhận một thú cưng thường' },
            { name: 'Trứng Hiếm', price: 25000, sellRate: 0.5, icon: '🥚✨', color: 'purple', effect: 'uncommonEgg', description: 'Nhận một thú cưng hiếm' },
            { name: 'Trứng Cực Hiếm', price: 75000, sellRate: 0.3, icon: '🥚🌟', color: 'gold', effect: 'rareEgg', description: 'Nhận một thú cưng cực hiếm' },
            { name: 'Trứng Huyền Thoại', price: 200000, sellRate: 0.1, icon: '🥚👑', color: 'red', effect: 'legendaryEgg', description: 'Nhận một thú cưng huyền thoại' }
        ];

        const newsPolls = [
            { question: "Mui lê hỏi: cho xin 50% số tiền đê", options: ["Đồng ý", "Không"], reward: { name: 'special', count: 0 }, special: 'muile' }
        ];

        const events = [
            { name: 'Mưa', description: 'Siêu tăng trưởng cây! Cây to hơn thường!', chance: 0.13, effect: 'growth', icon: '🌧️', duration: 15 },
            { name: 'Băng Giá', description: '25% cây bị đóng băng, giá trị x2!', chance: 0.1, effect: 'freeze', icon: '❄️', duration: 15, multiplier: 2.0 },
            { name: 'Bà Bụt', description: 'Một cây hóa vàng ánh sáng, giá trị x5!', chance: 0.1, effect: 'golden', icon: '✨', duration: 15, multiplier: 5.0 },
            { name: 'Sâu Bọ', description: '30% cây bị sâu ăn, giảm 50% giá trị!', chance: 0.05, effect: 'pest', icon: '🐛', duration: 15, multiplier: 0.5 },
            { name: 'Thị Trường Sốt', description: 'Giá bán cây tăng 50%!', chance: 0.05, effect: 'marketboom', icon: '📈', duration: 15, multiplier: 1.5 },
            { name: 'Pet Nổi Loạn', description: 'Thú cưng cho thêm 20% giá trị!', chance: 0.01, effect: 'petboost', icon: '🐾', duration: 15, multiplier: 1.2 },
            { name: 'Rainbow', description: '1% cây giá trị x20!', chance: 0.05, effect: 'rainbow', icon: '🌈', duration: 15, multiplier: 20.0 },
            { name: 'Đêm', description: 'Cửa hàng Đêm mở! 40% cây nhiễm đêm, giá trị x2!', chance: 0.1, effect: 'night', icon: '🌙', duration: 60, multiplier: 1.5 }, // Changed to 60s
            { name: 'Sấm Sét', description: '20% cây bị sét đánh, giá trị x3!', chance: 0.11, effect: 'thunder', icon: '⚡', duration: 15, multiplier: 3.0 },
            { name: 'Đại Dịch Zombie', description: '50% cây bị ăn mất, cây còn lại nhiễm zombie x2 tiền!', chance: 0.1, effect: 'zombie', icon: '🧟', duration: 15, multiplier: 2.0 },
            { name: 'Yêu Nước', description: '80% cây sinh ra có giá trị x1.5!', chance: 0.09, effect: 'patriot', icon: '🇻🇳', duration: 15, multiplier: 1.5 },
            { name: 'Bình Thường', description: 'Ngày yên ả, không có gì đặc biệt.', chance: 0.3, effect: 'none', icon: '☀️', duration: 15, multiplier: 1.0 },
            { name: 'Việt Tham Gia Trò Chơi!', description: 'Việt xuất hiện! Tất cả cây x60 giá trị!', chance: 0.05, effect: 'vietJoin', icon: '👨‍💻', duration: 15, multiplier: 60.0 },
            { name: 'Chocolate', description: 'Cây nhiễm Chocolate x4 giá trị!', chance: 0.01 , effect: 'chocolate', icon: '🍫', duration: 15, multiplier: 4.0 },
            { name: 'Mưa Sao Băng', description: '10% cây bị nhiễm mưa sao băng, giá trị x6!', chance: 0.1 , effect: 'meteorShower', icon: '☄️', duration: 15, multiplier: 6.0 }, // Changed duration to 125s
            { name: 'Người Ngoài Hành Tinh', description: '15% cây bị nhiễm người ngoài hành tinh, giá trị x3!', chance: 0.1, effect: 'alienLike', icon: '👽', duration: 15, multiplier: 3.0 }, // Changed duration to 125s
            { name: 'Sự Kiện Cổ Đại', description: 'Một sự kiện cổ đại xuất hiện! Hoàn thành nhiệm vụ để nhận thưởng!', chance:0.5 , effect: 'ancient', icon: '🗿', duration: 125, multiplier: 2.0 }, // Changed duration to 125s
            { name: 'Sự Kiện Thu Hoạch Cà Rốt Mùa Hè', description: 'Mùa hè đến rồi! Thu hoạch cà rốt để nhận thưởng đặc biệt!', chance:0.5 , effect: 'summerCarrot', icon: '☀️🥕', duration: 125, multiplier: 2.0 } // Changed duration to 125s
        ];

        const wheelRewards = [
            { name: 'Cây Noel', chance: 0.15, reward: { name: 'Cây Noel', count: 1 } },
            { name: 'Cây Táo Xanh', chance: 0.15, reward: { name: 'Cây Táo Xanh', count: 1 } },
            { name: 'Cây Hoa Anh Đào', chance: 0.10, reward: { name: 'Cây Hoa Anh Đào', count: 1 } },
            { name: 'Cây Cứt', chance: 0.08, reward: { name: 'Cây Cứt', count: 1 } },
            { name: 'Pizza', chance: 0.08, reward: { name: 'Pizza', count: 1 } },
            { name: 'Cây Candy', chance: 0.10, reward: { name: 'Cây Candy', count: 1 } },
            { name: 'Cây Gay', chance: 0.05, reward: { name: 'Cây Gay', count: 1 } },
            { name: 'Cây 3 lá', chance: 0.05, reward: { name: 'Cây 3 lá', count: 1 } },
            { name: 'Cây ATM', chance: 0.05, reward: { name: 'Cây ATM', count: 1 } },
            { name: 'Cây Trăng Khuyết', chance: 0.05, reward: { name: 'Cây Trăng Khuyết', count: 1 } }
        ];

        let money = 100;
        let inventory = {};
        let ownedPets = [];
        let plantedCrops = [];
        let plantedPets = [];
        let shopTimer = 60;  // Changed to 1 minute
        let petShopTimer = 120; // Changed to 2 minutes
        let itemShopTimer = 180; // Changed to 3 minutes
        let shopItemsBought = []; // Tracks names of items bought in current shop cycle
        let petShopItemsBought = []; // Tracks names of items bought in current pet shop cycle
        let itemShopItemsBought = []; // Tracks names of items bought in current item shop cycle
        let availableInShop = []; // Stores current items in shop with stock
        let availablePets = []; // Stores current eggs in pet shop with stock
        let availableItems = []; // Stores current items in item shop with stock
        let currentEvent = null;
        let eventTimer = 0;
        let notifications = [];
        let pendingSell = null;
        let wheelTimer = 3 * 60; // 3 minutes
        let wheelOpen = false;
        let wheelOpenDuration = 15;
        let lastFocusTime = Date.now();
        let petIntervals = {};
        let snakeGameInstance = null;
        let snakeGameTimer = 30;
        let snakeGameScore = 0;
        let snakeGameActive = false;
        let discountActive = false;
        let pendingUpgradePet = null;
        let maxGardenSlots = 2; // Starting with 2 slots, can expand to 6 via pet evolution
        let pendingEvolutionPet = null;
        
        let users = JSON.parse(localStorage.getItem('users')) || {};
        let currentUser = null;
        let currentAuthMode = 'login';
        // let selectedGiftRecipient = null; // Removed

        let upgradedPets = {
            'Khỉ': false,
            'Rồng': false,
            'Voi Mamut': false
        };

        let eggOpenQueue = [];
        let currentEggOpenTimer = 0;
        let currentEggOpenInterval = null;

        let zombieImmunity = false; // For ADMINGOOD cheat
        let pestImmunity = false;   // For ADMINGOOD cheat

        // New quest tracking variables
        let ancientQuestProgress = {
            plantSaundiceBoneTreeYield: false, // Tracks if Saundice Bone Tree planted with >12kg yield
            plantSaundiceBoneTreeValue: false, // Tracks if Saundice Bone Tree planted with >2650 money value
            own50Million: false
        };
        let ancientChestReady = false;
        let ancientChestTimer = 10;
        let ancientChestInterval = null;

        let summerCarrotQuestProgress = {
            buyCarrots: 0,
            harvestCarrots: 0,
            goldenCarrot: false
        };

        const getColorClass = (color) => ({
            orange: 'from-orange-400 to-orange-500',
            amber: 'from-amber-400 to-amber-600',
            yellow: 'from-yellow-400 to-yellow-500',
            green: 'from-green-400 to-green-500',
            purple: 'from-purple-400 to-purple-500',
            lime: 'from-lime-400 to-lime-500',
            pink: 'from-pink-400 to-pink-500',
            brown: 'from-amber-700 to-amber-800',
            emerald: 'from-emerald-400 to-emerald-500',
            blue: 'from-blue-400 to-blue-600',
            red: 'from-red-400 to-red-600',
            gray: 'from-gray-400 to-gray-600',
            gold: 'from-yellow-600 to-yellow-700',
            cyan: 'from-cyan-400 to-cyan-600',
            indigo: 'from-indigo-400 to-indigo-600'
        })[color] || 'from-gray-400 to-gray-600';

        const addNotification = (message, duration = 3200) => {
            const id = Date.now();
            notifications.push({ id, message });
            renderNotifications();
            setTimeout(() => {
                notifications = notifications.filter(n => n.id !== id);
                renderNotifications();
            }, duration);
        };

        // Helper function to get random stock (1 or 2)
        const getRandomStock = () => Math.floor(Math.random() * 2) + 1;

        const renderShop = () => {
            const shopTitle = document.getElementById('shop-title');
            const shopItemsDiv = document.getElementById('shop-items');
            
            let shopCrops = crops.filter(c => c.name !== 'Admin Seed' && c.name !== 'Cây Xương Ai Cập' && c.name !== 'Cây Xương Đêm Đen' && c.name !== 'Cây Xương Saundice');
            if (money >= 500000000 && Math.random() < 0.1) {
                shopCrops.push({ name: 'Admin Seed', price: 500000000, sellRate: 0.001, minYield: 100, maxYield: 200, multiplier: 2000, icon: '🌟', color: 'gold', nightOnly: true });
            }
            
            let newAvailableInShop = [];
            if (currentEvent?.effect === 'night') {
                shopTitle.innerHTML = 'Cửa hàng Đêm 🌙';
                newAvailableInShop = shopCrops.filter(c => c.nightOnly && Math.random() < c.sellRate);
            } else {
                shopTitle.innerHTML = 'IU Shop';
                newAvailableInShop = shopCrops.filter(crop => !crop.nightOnly && Math.random() < crop.sellRate);
            }
            // Always regenerate availableInShop with new stock
            availableInShop = newAvailableInShop.map(item => ({ ...item, stock: getRandomStock() }));

            shopItemsDiv.innerHTML = availableInShop.map(crop => `
                <div class="bg-gradient-to-r ${getColorClass(crop.color)} p-4 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">${crop.icon}</span>
                            <div>
                                <h3 class="font-semibold text-lg">${crop.name}</h3>
                                <p class="text-sm">${(discountActive ? Math.floor(crop.price * 0.5) : crop.price).toLocaleString()}$</p>
                                <p class="text-xs">${crop.minYield}-${crop.maxYield}kg (x${crop.stock})</p>
                            </div>
                        </div>
                        <button onclick="buyItem('${crop.name}', ${discountActive ? Math.floor(crop.price * 0.5) : crop.price}, 'crop')" class="bg-blue-200/20 px-4 py-2 rounded-full hover:bg-blue-200/30 text-white font-semibold transition-all duration-200 ${money < (discountActive ? Math.floor(crop.price * 0.5) : crop.price) || crop.stock <= 0 ? 'bg-gray-500/20 cursor-not-allowed opacity-50' : ''}" ${money < (discountActive ? Math.floor(crop.price * 0.5) : crop.price) || crop.stock <= 0 ? 'disabled' : ''}>Mua</button>
                    </div>
                </div>
            `).join('');
        };

        const renderPetShop = () => {
            const petShopItemsDiv = document.getElementById('pet-shop-items');
            
            const eggItems = items.filter(item => item.effect && item.effect.endsWith('Egg'));
            let newAvailableEggs = eggItems.filter(egg => Math.random() < egg.sellRate);
            // Always regenerate availablePets with new stock
            availablePets = newAvailableEggs.map(item => ({ ...item, stock: getRandomStock() }));

            petShopItemsDiv.innerHTML = availablePets.map(egg => `
                <div class="bg-gradient-to-r ${getColorClass(egg.color)} p-4 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">${egg.icon}</span>
                            <div>
                                <h3 class="font-semibold text-lg">${egg.name}</h3>
                                <p class="text-sm">${(discountActive ? Math.floor(egg.price * 0.5) : egg.price).toLocaleString()}$</p>
                                <p class="text-xs">${egg.description} (x${egg.stock})</p>
                            </div>
                        </div>
                        <button onclick="buyItem('${egg.name}', ${discountActive ? Math.floor(egg.price * 0.5) : egg.price}, 'item')" class="bg-pink-200/20 px-4 py-2 rounded-full hover:bg-pink-300/30 text-white font-semibold transition-all duration-200 ${money < (discountActive ? Math.floor(egg.price * 0.5) : egg.price) || egg.stock <= 0 ? 'bg-gray-500/20 cursor-not-allowed opacity-50' : ''}" ${money < (discountActive ? Math.floor(egg.price * 0.5) : egg.price) || egg.stock <= 0 ? 'disabled' : ''}>Mua</button>
                    </div>
                </div>
            `).join('');
        };

        const renderItemShop = () => {
            const itemShopItemsDiv = document.getElementById('item-shop-items');

            const regularItems = items.filter(item => !item.effect || !item.effect.endsWith('Egg'));
            let newAvailableItems = regularItems.filter(item => Math.random() < item.sellRate);
            // Always regenerate availableItems with new stock
            availableItems = newAvailableItems.map(item => ({ ...item, stock: getRandomStock() }));

            itemShopItemsDiv.innerHTML = availableItems.map(item => `
                <div class="bg-gradient-to-r ${getColorClass(item.color)} p-4 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">${item.icon}</span>
                            <div>
                                <h3 class="font-semibold text-lg">${item.name}</h3>
                                <p class="text-sm">${(discountActive ? Math.floor(item.price * 0.5) : item.price).toLocaleString()}$</p>
                                <p class="text-xs">${item.description} (x${item.stock})</p>
                            </div>
                        </div>
                        <button onclick="buyItem('${item.name}', ${discountActive ? Math.floor(item.price * 0.5) : item.price}, 'item')" class="bg-green-200/20 px-4 py-2 rounded-full hover:bg-green-300/30 text-white font-semibold transition-all duration-200 ${money < (discountActive ? Math.floor(item.price * 0.5) : item.price) || item.stock <= 0 ? 'bg-gray-500/20 cursor-not-allowed opacity-50' : ''}" ${money < (discountActive ? Math.floor(item.price * 0.5) : item.price) || item.stock <= 0 ? 'disabled' : ''}>Mua</button>
                    </div>
                </div>
            `).join('');
        };

        const renderInventory = () => {
            const inventoryItems = document.getElementById('inventory-items');
            inventoryItems.innerHTML = '';
            for (const [itemName, count] of Object.entries(inventory)) {
                const crop = crops.find(c => c.name === itemName);
                const item = items.find(i => i.name === itemName);

                if (crop && count > 0) {
                    inventoryItems.innerHTML += `
                        <button onclick="plantCrop('${crop.name}', 'crop')" class="bg-gradient-to-r ${getColorClass(crop.color)} p-3 rounded-xl text-white font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                            <div class="text-2xl mb-2">${crop.icon}</div>
                            <div class="text-sm">${crop.name}</div>
                            <div class="text-xs">x${count}</div>
                        </button>
                    `;
                } else if (item && count > 0) {
                    const isEgg = item.effect && item.effect.endsWith('Egg');
                    inventoryItems.innerHTML += `
                        <button onclick="${isEgg ? `showEggOpenModal('${item.name}')` : `useItem('${item.name}')`}" class="bg-gradient-to-r ${getColorClass(item.color)} p-3 rounded-xl text-white font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                            <div class="text-2xl mb-2">${item.icon}</div>
                            <div class="text-sm">${item.name}</div>
                            <div class="text-xs">x${count}</div>
                        </button>
                    `;
                }
            }
            for (const petName of ownedPets) {
                const pet = pets.find(p => p.name === petName);
                const isUpgraded = upgradedPets[pet.name];
                const petDisplayName = isUpgraded ? pet.upgrade.name : pet.name;
                const boneTreeCount = inventory['Cây Xương Ai Cập'] || 0;
                const upgradeButton = (pet.upgrade && !isUpgraded && money >= pet.upgrade.cost && boneTreeCount >= 1) ?
                    `<button onclick="showUpgradePetModal('${pet.name}')" class="mt-2 bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-2 py-1 rounded-full">Nâng Cấp</button>` : '';

                inventoryItems.innerHTML += `
                    <button onclick="plantCrop('${pet.name}', 'pet')" class="bg-gradient-to-r ${getColorClass(pet.color)} p-3 rounded-xl text-white font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                        <div class="text-2xl mb-2">${pet.icon}</div>
                        <div class="text-sm">${petDisplayName}</div>
                        <div class="text-xs">Pet</div>
                        ${upgradeButton}
                    </button>
                `;
            }
            inventoryItems.innerHTML += `
                <button onclick="startSnakeGame()" class="bg-gradient-to-r from-blue-400 to-blue-600 p-3 rounded-xl text-white font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    <div class="text-2xl mb-2">🐍</div>
                    <div class="text-sm">Rắn Săn Mồi</div>
                    <div class="text-xs">Chơi ngay!</div>
                </button>
            `;
        };

        const renderGarden = () => {
            const petGarden = document.getElementById('pet-garden');
            petGarden.innerHTML = plantedPets.map(plant => {
                let petClass = 'plant-ready cursor-pointer';
                if (plant.frozen) petClass += ' plant-frozen';
                if (plant.golden) petClass += ' plant-golden';
                if (plant.rainbow) petClass += ' plant-rainbow';
                if (plant.night) petClass += ' plant-night';
                if (plant.thunder) petClass += ' plant-thunder';
                if (plant.tung) petClass += ' plant-tung';
                if (plant.zombie) petClass += ' plant-zombie';
                if (plant.owl) petClass += ' plant-owl';
                
                // Check if pet is ready for evolution at level 5
                if (plant.level >= 5 && !plant.evolved) {
                    petClass += ' pet-evolution-ready';
                }

                const petDisplayName = upgradedPets[plant.item.name] ? plant.item.upgrade.name : plant.item.name;
                
                // Show cooldown timer for pets with active skills
                let cooldownDisplay = '';
                if (plant.cooldownTimer && plant.cooldownTimer > 0) {
                    const remainingTime = Math.ceil(plant.cooldownTimer);
                    cooldownDisplay = `<div class="cooldown-timer">${remainingTime}s</div>`;
                }

                return `
                    <div onclick="showPetDetails(${plant.id})" style="animation-delay: ${plant.pulseOffset}ms; --rotation: ${plant.rotationOffset}deg; position: relative;" class="bg-gradient-to-r ${getColorClass(plant.item.color)} p-4 rounded-xl text-white text-center shadow-lg transform hover:scale-105 transition-all duration-200 ${petClass}">
                        <div class="text-3xl mb-2">${plant.frozen ? '❄️' : ''}${plant.golden ? '✨' : ''}${plant.rainbow ? '🌈' : ''}${plant.night ? '🌙' : ''}${plant.thunder ? '⚡' : ''}${plant.tung ? '🌳' : ''}${plant.zombie ? '🧟' : ''}${plant.owl ? '🦉' : ''}${plant.item.icon}</div>
                        <div class="text-sm font-semibold">${petDisplayName}</div>
                        <div class="text-xs">💰 Sẵn sàng bán!</div>
                        ${plant.kg ? `<div class="text-xs mt-1">⚖️ ${plant.kg}kg | Lv.${plant.level || 1}</div>` : ''}
                        ${plant.experience !== undefined ? `<div class="text-xs">📈 Exp: ${plant.experience.toFixed(1)}/${(plant.level || 1) * 100}</div>` : ''}
                        ${plant.cooldownReduction ? `<div class="text-xs">⏱️ -${plant.cooldownReduction.toFixed(1)}% cooldown</div>` : ''}
                        ${plant.level >= 5 && !plant.evolved ? '<div class="text-xs mt-2 bg-purple-600/50 rounded px-2">🌟 Sẵn sàng tiến hóa!</div>' : ''}
                        ${plant.frozen ? '<div class="text-xs mt-2 bg-blue-200/30 rounded px-2">❄️ Đóng băng</div>' : ''}${plant.golden ? '<div class="text-xs mt-2 bg-yellow-500/30 rounded px-2">✨ Vàng</div>' : ''}${plant.rainbow ? '<div class="text-xs mt-2 bg-gradient-to-r from-red-200 to-purple-200 rounded px-2">🌈 Cầu vồng</div>' : ''}${plant.night ? '<div class="text-xs mt-2 bg-gray-600/30 rounded px-2">🌙 Nhiễm Đêm</div>' : ''}${plant.thunder ? '<div class="text-xs mt-2 bg-yellow-300/30 rounded px-2">⚡ Sét đánh</div>' : ''}${plant.tung ? '<div class="text-xs mt-2 bg-amber-700/30 rounded px-2">🌳 Tung Tung Sahur</div>' : ''}${plant.zombie ? '<div class="text-xs mt-2 bg-green-600/30 rounded px-2">🧟 Zombie</div>' : ''}${plant.owl ? '<div class="text-xs mt-2 bg-purple-600/30 rounded px-2">🦉 Cú tới chơi</div>' : ''}
                        ${cooldownDisplay}
                    </div>
                `;
            }).join('') + Array.from({ length: Math.max(0, maxGardenSlots - plantedPets.length) }).map(() => `
                <div class="bg-gradient-to-r from-gray-300 to-gray-400 p-4 rounded-xl border-2 border-dashed border-gray-500 flex items-center justify-center">
                    <span class="text-2xl opacity-30">🐾</span>
                </div>
            `).join('');

            const cropGarden = document.getElementById('crop-garden');
            cropGarden.innerHTML = plantedCrops.map(plant => {
                let plantClass = plant.isReady ? 'plant-ready cursor-pointer' : 'plant-grow';
                if (plant.frozen) plantClass += ' plant-frozen';
                if (plant.golden) plantClass += ' plant-golden';
                if (plant.pest) plantClass += ' plant-pest';
                if (plant.giant) plantClass += ' plant-giant';
                if (plant.rainbow) plantClass += ' plant-rainbow';
                if (plant.night) plantClass += ' plant-night';
                if (plant.thunder) plantClass += ' plant-thunder';
                if (plant.tung) plantClass += ' plant-tung';
                if (plant.zombie) plantClass += ' plant-zombie';
                if (plant.vietJoin) plantClass += ' plant-golden';
                if (plant.owl) plantClass += ' plant-owl';
                if (plant.chocolate) plantClass += ' plant-chocolate';
                if (plant.meteorShower) plantClass += ' plant-meteorShower'; // New class
                if (plant.alienLike) plantClass += ' plant-alienLike';     // New class
                if (plant.blackhole) plantClass += ' plant-blackhole';     // New class
                if (plant.superHarvest) plantClass += ' plant-superHarvest'; // New class

                return `
                    <div onclick="${plant.isReady ? `evaluatePlant(${plant.id}, 'crop')` : ''}" style="animation-delay: ${plant.pulseOffset}ms; --rotation: ${plant.rotationOffset}deg;" class="bg-gradient-to-r ${getColorClass(plant.item.color)} p-4 rounded-xl text-white text-center shadow-lg transform hover:scale-105 transition-all duration-200 ${plantClass}">
                        <div class="text-3xl mb-2">${plant.frozen ? '❄️' : ''}${plant.golden ? '✨' : ''}${plant.pest ? '🐛' : ''}${plant.giant ? '🦣' : ''}${plant.rainbow ? '🌈' : ''}${plant.night ? '🌙' : ''}${plant.thunder ? '⚡' : ''}${plant.tung ? '🌳' : ''}${plant.zombie ? '🧟' : ''}${plant.vietJoin ? '👨‍💻' : ''}${plant.owl ? '🦉' : ''}${plant.chocolate ? '🍫' : ''}${plant.meteorShower ? '☄️' : ''}${plant.alienLike ? '👽' : ''}${plant.blackhole ? '⚫' : ''}${plant.superHarvest ? '🌟' : ''}${plant.item.icon}</div>
                        <div class="text-sm font-semibold">${plant.item.name}</div>
                        <div class="text-xs">${plant.isReady ? '💰 Sẵn sàng!' : '🌱 Đang lớn...'}</div>
                        ${plant.isReady ? `<div class="text-xs mt-2">Khối lượng: ${plant.yieldWeight}kg</div>` : ''}
                        ${plant.eventAffected && plant.eventAffected?.effect === 'growth' ? '<div class="text-xs mt-2 bg-blue-500/30 rounded px-2">🌧️ Mưa</div>' : ''}${plant.frozen ? '<div class="text-xs mt-2 bg-blue-200/30 rounded px-2">❄️ Đóng băng</div>' : ''}${plant.golden ? '<div class="text-xs mt-2 bg-yellow-500/30 rounded px-2">✨ Vàng</div>' : ''}${plant.pest ? '<div class="text-xs mt-2 bg-red-500/20 rounded px-2">🐛 Sâu bọ</div>' : ''}${plant.giant ? '<div class="text-xs mt-2 bg-gray-500/30 rounded px-2">🦣 Khổng lồ</div>' : ''}${plant.rainbow ? '<div class="text-xs mt-2 bg-gradient-to-r from-red-200 to-purple-200 rounded px-2">🌈 Cầu vồng</div>' : ''}${plant.night ? '<div class="text-xs mt-2 bg-gray-600/30 rounded px-2">🌙 Nhiễm Đêm</div>' : ''}${plant.thunder ? '<div class="text-xs mt-2 bg-yellow-300/30 rounded px-2">⚡ Sét đánh</div>' : ''}${plant.tung ? '<div class="text-xs mt-2 bg-amber-700/30 rounded px-2">🌳 Tung Tung Sahur</div>' : ''}${plant.zombie ? '<div class="text-xs mt-2 bg-green-600/30 rounded px-2">🧟 Zombie</div>' : ''}${plant.vietJoin ? '<div class="text-xs mt-2 bg-purple-500/30 rounded px-2">👨‍💻 Việt Tham Gia</div>' : ''}${plant.owl ? '<div class="text-xs mt-2 bg-purple-600/30 rounded px-2">🦉 Cú tới chơi</div>' : ''}${plant.chocolate ? '<div class="text-xs mt-2 bg-amber-700/30 rounded px-2">🍫 Chocolate</div>' : ''}${plant.meteorShower ? '<div class="text-xs mt-2 bg-red-500/30 rounded px-2">☄️ Mưa Sao Băng</div>' : ''}${plant.alienLike ? '<div class="text-xs mt-2 bg-lime-500/30 rounded px-2">👽 Người Ngoài Hành Tinh</div>' : ''}${plant.blackhole ? '<div class="text-xs mt-2 bg-gray-800/30 rounded px-2">⚫ Hố Đen</div>' : ''}${plant.superHarvest ? '<div class="text-xs mt-2 bg-yellow-500/30 rounded px-2">🌟 Siêu Thu Hoạch</div>' : ''}
                    </div>
                `;
            }).join('') + Array.from({ length: Math.max(0, 15 - plantedCrops.length) }).map(() => `
                <div class="bg-gradient-to-r from-gray-300 to-gray-400 p-4 rounded-xl border-2 border-dashed border-gray-500 flex items-center justify-center">
                    <span class="text-2xl opacity-30">🌿</span>
                </div>
            `).join('');
        };

        const renderNotifications = () => {
            const notificationsDiv = document.getElementById('notifications');
            notificationsDiv.innerHTML = notifications.map(n => `
                <div class="bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg animate-bounce max-w-xs">${n.message}</div>
            `).join('');
        };

        const renderEvent = () => {
            const eventDiv = document.getElementById('current-event');
            const eventIconSpan = document.getElementById('event-icon');
            const eventNameH3 = document.getElementById('event-name');
            const eventDescriptionP = document.getElementById('event-description');
            const eventTimerP = document.getElementById('event-timer');
            const eventQuestDetailsDiv = document.getElementById('event-quest-details');

            if (currentEvent && currentEvent.effect !== 'none') {
                eventDiv.classList.remove('hidden');
                eventIconSpan.textContent = currentEvent.icon;
                eventNameH3.textContent = `Sự kiện: ${currentEvent.name}`;
                eventDescriptionP.textContent = currentEvent.description;
                eventTimerP.textContent = `Còn lại: ${Math.ceil(eventTimer)}s`;

                // Update quest details directly in the event notification area
                if (currentEvent.effect === 'ancient') {
                    eventQuestDetailsDiv.innerHTML = `
                        <ul class="list-disc list-inside">
                            <li>Trồng một Cây Xương Saundice và đạt trên 12kg: <span class="font-semibold">${ancientQuestProgress.plantSaundiceBoneTreeYield ? '✅' : '❌'}</span></li>
                            <li>Trồng một Cây Xương Saundice và giá trị của nó trên 2650 tiền: <span class="font-semibold">${ancientQuestProgress.plantSaundiceBoneTreeValue ? '✅' : '❌'}</span></li>
                            <li>Sở hữu 50,000,000$: <span class="font-semibold">${money >= 50000000 ? '✅' : '❌'}</span></li>
                        </ul>
                    `;
                } else if (currentEvent.effect === 'summerCarrot') {
                    eventQuestDetailsDiv.innerHTML = `
                        <ul class="list-disc list-inside">
                            <li>Mua 25 Cà rốt: <span class="font-semibold">${summerCarrotQuestProgress.buyCarrots >= 25 ? '✅' : `❌ (${summerCarrotQuestProgress.buyCarrots}/25)`}</span></li>
                            <li>Thu hoạch 25 Cà rốt: <span class="font-semibold">${summerCarrotQuestProgress.harvestCarrots >= 25 ? '✅' : `❌ (${summerCarrotQuestProgress.harvestCarrots}/25)`}</span></li>
                            <li>Sở hữu 1 Cà rốt vàng: <span class="font-semibold">${summerCarrotQuestProgress.goldenCarrot ? '✅' : '❌'}</span></li>
                        </ul>
                    `;
                } else {
                    eventQuestDetailsDiv.innerHTML = ''; // Clear quest details for other events
                }

            } else {
                eventDiv.classList.add('hidden');
                eventQuestDetailsDiv.innerHTML = ''; // Clear quest details when no event
                // Ensure quest modals are hidden when event ends
                document.getElementById('ancient-quest-modal').classList.add('hidden');
                document.getElementById('summer-carrot-quest-modal').classList.add('hidden');
            }
        };

        // Function to open the specific quest modal when the event notification is clicked
        const openEventQuestModal = () => {
            if (currentEvent) {
                if (currentEvent.effect === 'ancient') {
                    showAncientQuestModal();
                } else if (currentEvent.effect === 'summerCarrot') {
                    showSummerCarrotQuestModal();
                }
            }
        };


        const buyItem = (name, price, type) => {
            if (money >= price) {
                let itemFound = false;
                if (type === 'crop') {
                    const cropInShop = availableInShop.find(c => c.name === name);
                    if (cropInShop && cropInShop.stock > 0) { 
                        money -= price;
                        inventory[name] = (inventory[name] || 0) + 1;
                        cropInShop.stock--; 
                        addNotification(`Đã mua ${name}!`);
                        itemFound = true;
                        if (name === 'Cà rốt' && currentEvent?.effect === 'summerCarrot') {
                            summerCarrotQuestProgress.buyCarrots++;
                            updateSummerCarrotQuestProgress(); // Update quest progress immediately
                        }
                    }
                } else if (type === 'item') {
                    const itemInShop = availableItems.find(i => i.name === name);
                    const petEggInShop = availablePets.find(i => i.name === name);
                    
                    if (itemInShop && itemInShop.stock > 0) {
                        money -= price;
                        inventory[name] = (inventory[name] || 0) + 1;
                        itemInShop.stock--;
                        addNotification(`Đã mua ${name}!`);
                        itemFound = true;
                    } else if (petEggInShop && petEggInShop.stock > 0) {
                        money -= price;
                        inventory[name] = (inventory[name] || 0) + 1;
                        petEggInShop.stock--;
                        addNotification(`Đã mua ${name}!`);
                        itemFound = true;
                    }
                }

                if (itemFound) {
                    document.getElementById('money').textContent = `${money.toLocaleString()}$`;
                    renderInventory();
                    // Re-render shops to show updated stock or new items
                    renderShop();
                    renderPetShop();
                    renderItemShop();
                    saveGameState();
                } else {
                    addNotification('Không tìm thấy mặt hàng hoặc đã hết hàng!');
                }
            } else {
                addNotification('Không đủ tiền!');
            }
        };

        const getRandomPetFromList = (petList) => {
            const random = Math.random();
            let cumulativeChance = 0;
            for (const petEntry of petList) {
                cumulativeChance += petEntry.chance;
                if (random < cumulativeChance) {
                    return pets.find(p => p.name === petEntry.name);
                }
            }
            return null;
        };

        let eggOpenTimeout = null;
        const showEggOpenModal = (eggName) => {
            if (eggOpenQueue.length > 0) {
                addNotification('Bạn đang mở một quả trứng khác. Vui lòng đợi!');
                return;
            }

            eggOpenQueue.push(eggName);
            document.getElementById('egg-open-info').textContent = `Bạn muốn mở ${eggName}?`;
            document.getElementById('egg-open-modal').classList.remove('hidden');
            document.getElementById('open-egg-button').disabled = true;
            currentEggOpenTimer = 10;
            document.getElementById('egg-open-timer').textContent = `Thời gian chờ: ${currentEggOpenTimer}s`;

            currentEggOpenInterval = setInterval(() => {
                currentEggOpenTimer--;
                document.getElementById('egg-open-timer').textContent = `Thời gian chờ: ${currentEggOpenTimer}s`;
                if (currentEggOpenTimer <= 0) {
                    clearInterval(currentEggOpenInterval);
                    document.getElementById('open-egg-button').disabled = false;
                    document.getElementById('egg-open-timer').textContent = `Sẵn sàng mở!`;
                }
            }, 1000);
        };

        const openEgg = () => {
            if (eggOpenQueue.length === 0) return;

            const eggName = eggOpenQueue.shift();
            const item = items.find(i => i.name === eggName);

            if (!item || inventory[eggName] <= 0) {
                addNotification(`Bạn không có ${eggName} để mở!`);
                cancelEggOpen();
                return;
            }

            inventory[eggName]--;
            if (inventory[eggName] === 0) delete inventory[eggName]; // Ensure item is removed if count is 0
            addNotification(`Đang mở ${eggName}...`);

            let petReward = null;
            if (item.effect === 'commonEgg') {
                const commonPets = [
                    { name: 'Chó', chance: 0.40 },
                    { name: 'Mèo', chance: 0.35 },
                    { name: 'Zombie Kid', chance: 0.15 },
                    { name: 'Khỉ', chance: 0.05 }
                ];
                petReward = getRandomPetFromList(commonPets);
            } else if (item.effect === 'uncommonEgg') {
                const uncommonPets = [
                    { name: 'Cá Sấu', chance: 0.20 },
                    { name: 'Dơi', chance: 0.20 },
                    { name: 'Ếch', chance: 0.20 },
                    { name: 'Rồng', chance: 0.20 },
                    { name: 'Chuột Xám', chance: 0.20 }
                ];
                petReward = getRandomPetFromList(uncommonPets);
            } else if (item.effect === 'rareEgg') {
                const rarePets = [
                    { name: 'Tung Tung Sahur', chance: 0.30 },
                    { name: 'Khủng Long', chance: 0.20 },
                    { name: 'Cú', chance: 0.15 },
                    { name: 'Bướm Bướm', chance: 0.15 },
                    { name: 'Chuột Sakura', chance: 0.15 }
                
                ];
                petReward = getRandomPetFromList(rarePets);
            } else if (item.effect === 'legendaryEgg') {
                const legendaryPets = [
                    { name: 'Voi Mamut', chance: 0.30 },
                    { name: 'Tralala!', chance: 0.25 },
                    { name: 'Squid', chance: 0.15 },
                    { name: 'Chuột Hamster', chance: 0.30 } // 30% chance for Hamster
                ];
                petReward = getRandomPetFromList(legendaryPets);
            }

            if (petReward) {
                ownedPets.push(petReward.name);
                addNotification(`🎉 Bạn đã nhận được ${petReward.name} từ ${eggName}!`);
            } else {
                addNotification(`Không nhận được thú cưng nào từ ${eggName}.`);
            }

            cancelEggOpen();
            renderGarden();
            renderInventory();
            saveGameState();
        };

        const cancelEggOpen = () => {
            clearInterval(currentEggOpenInterval);
            eggOpenQueue = [];
            document.getElementById('egg-open-modal').classList.add('hidden');
            document.getElementById('open-egg-button').disabled = true;
        };

        const hasPet = (petName) => plantedPets.some(p => p.item.name === petName);

        const plantCrop = (name, type) => {
            if (type === 'crop') {
                if (plantedCrops.length >= 15) {
                    addNotification('Vườn cây đã đầy! Hãy thu hoạch cây trước khi trồng thêm.');
                    return;
                }
                if (inventory[name] > 0) {
                    const crop = crops.find(c => c.name === name);
                    inventory[name] -= 1;
                    if (inventory[name] === 0) delete inventory[name];
                    const growthMultiplier = hasPet('Mèo') ? 0.8 : 1;
                    const newPlant = {
                        id: Date.now(),
                        item: crop,
                        type: 'crop',
                        plantTime: Date.now(),
                        growthTime: (currentEvent?.effect === 'growth' ? Math.random() * 2000 + 1000 : Math.random() * 5000 + 3000) * growthMultiplier,
                        isReady: false,
                        yieldWeight: 0,
                        eventAffected: currentEvent?.effect !== 'none' ? currentEvent : null,
                        persistentEvents: [], // Array to store all events that have affected this tree
                        rotationOffset: Math.random() * 2 - 1,
                        pulseOffset: Math.random() * 1000,
                        frozen: false,
                        golden: false,
                        pest: false,
                        giant: false,
                        rainbow: false,
                        night: false,
                        thunder: false,
                        tung: false,
                        zombie: false,
                        doubled: false,
                        patriot: currentEvent?.effect === 'patriot' && Math.random() < 0.8,
                        vietJoin: currentEvent?.effect === 'vietJoin',
                        permanentViet: false,
                        owl: false,
                        chocolate: false,
                        meteorShower: false, 
                        alienLike: false,    
                        blackhole: false,
                        superHarvest: false // New property for Carrot Pig
                    };
                    plantedCrops.push(newPlant);
                    setTimeout(() => {
                        const plant = plantedCrops.find(p => p.id === newPlant.id);
                        if (plant) {
                            plant.isReady = true;
                            plant.yieldWeight = Math.floor(Math.random() * (plant.item.maxYield - plant.item.minYield + 1) + plant.item.minYield);
                            
                            // Calculate initial value for Saundice Bone Tree quest
                            if (plant.item.name === 'Cây Xương Saundice') {
                                const initialYield = Math.floor(Math.random() * (plant.item.maxYield - plant.item.minYield + 1) + plant.item.minYield);
                                const initialValue = initialYield * plant.item.multiplier * (plant.item.price < 7000 ? 7 : 5);
                                
                                if (initialYield > 12) {
                                    ancientQuestProgress.plantSaundiceBoneTreeYield = true;
                                }
                                if (initialValue > 2650) {
                                    ancientQuestProgress.plantSaundiceBoneTreeValue = true;
                                }
                                updateAncientQuestProgress(); // Update quest progress immediately
                            }

                            renderGarden();
                            saveGameState();
                        }
                    }, newPlant.growthTime);
                    addNotification(`Đã trồng ${name}!`);
                    renderInventory();
                    renderGarden();
                    saveGameState();
                }
            } else if (type === 'pet') {
                if (plantedPets.length >= maxGardenSlots) {
                    addNotification(`Vườn thú cưng đã đầy! (${plantedPets.length}/${maxGardenSlots}) Hãy bán thú cưng trước khi thả thêm.`);
                    return;
                }
                if (ownedPets.includes(name)) {
                    const pet = pets.find(p => p.name === name);
                    // Generate pet kg (90% < 5kg, 10% 5-15kg)
                    const petKg = Math.random() < 0.9 ? 
                        Math.random() * 5 : // 0-5kg
                        (Math.random() * 10) + 5; // 5-15kg
                    
                    const newPet = {
                        id: Date.now(),
                        item: pet,
                        type: 'pet',
                        plantTime: Date.now(),
                        isReady: true,
                        yieldWeight: 1,
                        eventAffected: null,
                        rotationOffset: Math.random() * 2 - 1,
                        pulseOffset: Math.random() * 1000,
                        frozen: false,
                        golden: false,
                        rainbow: false,
                        night: false,
                        thunder: false,
                        tung: false,
                        zombie: false,
                        doubled: false,
                        isUpgraded: upgradedPets[name],
                        owl: false,
                        kg: Math.round(petKg * 10) / 10, // Pet weight with kg system
                        level: 1, // Initial level
                        experience: 0, // Initial experience
                        cooldownReduction: Math.round(petKg * 10) / 10 * 2 + 1 * 0.5 // Calculate cooldown reduction: kg*2% + level*0.5%
                    };
                    plantedPets.push(newPet);
                    ownedPets = ownedPets.filter(p => p !== name);
                    addNotification(`Đã thả ${newPet.isUpgraded ? pet.upgrade.name : name} vào vườn!`);
                    setupPetEffect(newPet);
                    renderInventory();
                    renderGarden();
                    saveGameState();
                }
            }
        };

        const useItem = (itemName) => {
            const item = items.find(i => i.name === itemName);
            if (!item || inventory[itemName] <= 0) {
                addNotification(`Bạn không có ${itemName} để sử dụng!`);
                return;
            }

            if (plantedCrops.length === 0) {
                addNotification('Không có cây nào trong vườn để sử dụng vật phẩm!');
                return;
            }

            inventory[itemName]--;
            if (inventory[itemName] === 0) delete inventory[itemName];

            const targetPlant = plantedCrops[Math.floor(Math.random() * plantedCrops.length)];

            switch (item.effect) {
                case 'waterSpray1': // 20% chance for +1/+2 kg
                    if (Math.random() < 0.20) {
                        const boost = Math.random() < 0.5 ? 1 : 2;
                        targetPlant.yieldWeight += boost;
                        addNotification(`💧 ${targetPlant.item.name} tăng ${boost}kg nhờ Vòi phun nước cấp 1! (${targetPlant.yieldWeight}kg)`);
                    }
                    break;
                case 'waterSpray2': // 25% chance for +2-5 kg
                    if (Math.random() < 0.25) {
                        const boost = Math.floor(Math.random() * 4) + 2; // 2-5
                        targetPlant.yieldWeight += boost;
                        addNotification(`💦 ${targetPlant.item.name} tăng ${boost}kg nhờ Vòi phun nước cấp 2! (${targetPlant.yieldWeight}kg)`);
                    }
                    break;
                case 'waterSpray3': // 25% chance for x1.5 yield
                    if (Math.random() < 0.25) {
                        targetPlant.yieldWeight = Math.round(targetPlant.yieldWeight * 1.5);
                        addNotification(`🚿 ${targetPlant.item.name} tăng sản lượng lên ${targetPlant.yieldWeight}kg nhờ Vòi phun nước cấp 3!`);
                    }
                    break;
                case 'chocolateSpray': // Cây to ra x1.5 (30%), nhiễm Chocolate x4 (20%)
                    if (Math.random() < 0.30) { // 30% chance for giant
                        targetPlant.giant = true; // Keep giant effect for chocolate spray
                        addNotification(`🍫💧 ${targetPlant.item.name} đã to ra nhờ Vòi phun nước Chocolate!`);
                    }
                    if (Math.random() < 0.20) { // 20% chance for chocolate
                        targetPlant.chocolate = true;
                        addNotification(`🍫💧 ${targetPlant.item.name} bị nhiễm Chocolate từ Vòi phun nước Chocolate!`);
                    }
                    break;
                case 'superGrowthSpray': // Super Growth Big Tree Spray (30% x 30% kg)
                    const isSuperGrowthTree = targetPlant.persistentEvents?.some(e => e.effect === 'growth') || targetPlant.eventAffected?.effect === 'growth';
                    const effectChance = isSuperGrowthTree ? 1.0 : 0.30; // 100% for Super Growth event trees, 30% for others
                    
                    if (Math.random() < effectChance) {
                        const currentWeight = targetPlant.yieldWeight;
                        const boost = Math.round(currentWeight * 0.30); // 30% increase
                        targetPlant.yieldWeight += boost;
                        const effectNote = isSuperGrowthTree ? " (Super Growth Tree - 100% hiệu quả!)" : " (30% hiệu ứng)";
                        addNotification(`🌟💧 ${targetPlant.item.name} tăng ${boost}kg nhờ Super Growth Big Tree Spray! (${targetPlant.yieldWeight}kg)${effectNote}`);
                    } else {
                        addNotification(`🌟💧 Super Growth Big Tree Spray không có hiệu quả trên ${targetPlant.item.name} lần này.`);
                    }
                    break;
                default:
                    addNotification(`Vật phẩm ${itemName} không có hiệu ứng sử dụng.`);
                    break;
            }
            renderInventory();
            renderGarden();
            saveGameState();
        };

        const setupPetEffect = (pet) => {
            const petName = pet.item.name;
            const isUpgraded = pet.isUpgraded;
            
            // Calculate cooldown reduction from kg and level
            if (pet.kg && pet.level) {
                const kgReduction = pet.kg * 0.02; // 1kg = -2% cooldown
                const levelReduction = pet.level * 0.005; // lv 1 = -0.5%, lv 2 = -1%, etc.
                
                // For passive pets (Gray Mouse, Hamster), cooldown INCREASES instead of decreases as trade-off
                if (pet.item.effect === 'grayMouse' || pet.item.effect === 'hamster') {
                    pet.cooldownReduction = -(kgReduction + levelReduction) * 100; // Negative = increase cooldown
                } else {
                    pet.cooldownReduction = (kgReduction + levelReduction) * 100;
                }
            }
            
            if (petIntervals[pet.id]) clearInterval(petIntervals[pet.id]);

            if (petName === 'Chó') {
                const baseCooldown = 15000;
                const actualCooldown = pet.cooldownReduction ? 
                    baseCooldown * (1 - pet.cooldownReduction / 100) : baseCooldown;
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id)) {
                        const currentPet = plantedPets.find(p => p.id === pet.id);
                        const randomCrop = crops[Math.floor(Math.random() * crops.length)];
                        inventory[randomCrop.name] = (inventory[randomCrop.name] || 0) + 1;
                        addNotification(`🐶 Chó mang về 1 ${randomCrop.name}!`);
                        currentPet.cooldownTimer = actualCooldown / 1000; // Set cooldown timer in seconds
                        renderInventory();
                        saveGameState();
                    } else {
                        clearInterval(petIntervals[pet.id]);
                    }
                }, actualCooldown);
            } else if (petName === 'Bướm Bướm') {
                const baseCooldown = 25000;
                const actualCooldown = pet.cooldownReduction ? 
                    baseCooldown * (1 - pet.cooldownReduction / 100) : baseCooldown;
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id) && plantedCrops.length > 0) {
                        const randomIndex = Math.floor(Math.random() * plantedCrops.length);
                        plantedCrops[randomIndex].golden = true;
                        addNotification(`🦋 Bướm Bướm hóa vàng ${plantedCrops[randomIndex].item.name}!`);
                        renderGarden();
                        saveGameState();
                        if (plantedCrops[randomIndex].item.name === 'Cà rốt' && currentEvent?.effect === 'summerCarrot') {
                            summerCarrotQuestProgress.goldenCarrot = true;
                            updateSummerCarrotQuestProgress(); // Update quest progress immediately
                        }
                    } else if (!plantedCrops.length) {
                        addNotification(`🦋 Bướm Bướm không tìm thấy cây để hóa vàng!`);
                    }
                }, actualCooldown);
            } else if (petName === 'Tralala!') {
                const baseCooldown = 40000;
                const actualCooldown = pet.cooldownReduction ? 
                    baseCooldown * (1 - pet.cooldownReduction / 100) : baseCooldown;
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id) && plantedCrops.length > 0) {
                        const randomIndex = Math.floor(Math.random() * plantedCrops.length);
                        plantedCrops[randomIndex].rainbow = true;
                        addNotification(`🌈 Tralala! khiến ${plantedCrops[randomIndex].item.name} hóa cầu vồng!`);
                        renderGarden();
                        saveGameState();
                    } else if (!plantedCrops.length) {
                        addNotification(`🦈 Tralala! không tìm thấy cây để hóa cầu vồng!`);
                    }
                }, actualCooldown);
            } else if (petName === 'Rồng') {
                const baseCooldown = 5000;
                const actualCooldown = pet.cooldownReduction ? 
                    baseCooldown * (1 - pet.cooldownReduction / 100) : baseCooldown;
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id)) {
                        const minCash = isUpgraded ? pet.item.upgrade.minMoney : 1000;
                        const maxCash = isUpgraded ? pet.item.upgrade.maxMoney : 2000;
                        const cash = Math.floor(Math.random() * (maxCash - minCash + 1)) + minCash;
                        money += cash;
                        document.getElementById('money').textContent = `${money.toLocaleString()}$`;
                        addNotification(`🐉 ${isUpgraded ? 'Rồng v2' : 'Rồng'} cho ${cash.toLocaleString()}$!`);
                        saveGameState();
                    } else {
                        clearInterval(petIntervals[pet.id]);
                    }
                }, actualCooldown);
            } else if (petName === 'Voi Mamut') {
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id) && plantedCrops.length > 0) {
                        const eligiblePlants = plantedCrops.filter(p => !p.doubled);
                        if (eligiblePlants.length > 0) {
                            const randomIndex = Math.floor(Math.random() * eligiblePlants.length);
                            const plant = eligiblePlants[randomIndex];
                            const yieldMultiplier = isUpgraded ? pet.item.upgrade.multiplier : 2;
                            plant.isReady = true;
                            plant.yieldWeight = Math.floor(Math.random() * (plant.item.maxYield - plant.item.minYield + 1) + plant.item.minYield) * yieldMultiplier;
                            plant.doubled = true;
                            addNotification(`🦣 ${isUpgraded ? 'Voi Mamut v2' : 'Voi Mamut'} khiến ${plant.item.name} gấp đôi sản lượng (${plant.yieldWeight}kg)!`);
                            renderGarden();
                            saveGameState();
                        } else {
                            addNotification(`🦣 ${isUpgraded ? 'Voi Mamut v2' : 'Voi Mamut'} không tìm thấy cây nào chưa được nhân đôi!`);
                        }
                    } else if (!plantedCrops.length) {
                        addNotification(`🦣 ${isUpgraded ? 'Voi Mamut v2' : 'Voi Mamut'} không tìm thấy cây để làm lớn!`);
                    }
                }, 20000);
            } else if (petName === 'Ếch') {
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id)) {
                        addNotification(`🐸 Ếch bảo vệ vườn khỏi sâu bọ!`);
                    } else {
                        clearInterval(petIntervals[pet.id]);
                    }
                }, 30000);
            } else if (petName === 'Dơi') {
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id) && Object.keys(inventory).length > 0) {
                        const cropNames = Object.keys(inventory).filter(name => inventory[name] > 0);
                        if (cropNames.length > 0) {
                            const randomCrop = cropNames[Math.floor(Math.random() * cropNames.length)];
                            inventory[randomCrop] += 2;
                            addNotification(`🦇 Dơi nhân bản x2 ${randomCrop}!`);
                            renderInventory();
                            saveGameState();
                        } else {
                            addNotification(`🦇 Dơi không tìm thấy hạt giống để nhân bản!`);
                        }
                    } else {
                        clearInterval(petIntervals[pet.id]);
                    }
                }, 20000);
            } else if (petName === 'Tung Tung Sahur') {
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id) && plantedCrops.length > 0) {
                        const randomIndex = Math.floor(Math.random() * plantedCrops.length);
                        if (Math.random() < 0.5) {
                            plantedCrops[randomIndex].tung = true;
                            addNotification(`🌳 Tung Tung Sahur khiến ${plantedCrops[randomIndex].item.name} nhiễm Tung Tung Sahur! (x4 giá trị)`);
                            renderGarden();
                            saveGameState();
                        }
                    } else if (!plantedCrops.length) {
                        addNotification(`🌳 Tung Tung Sahur không tìm thấy cây để nhiễm!`);
                    }
                }, 20000);
            } else if (petName === 'Cá Sấu') {
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id)) {
                        addNotification(`🐊 Cá Sấu bảo vệ vườn khỏi zombie!`);
                    } else {
                        clearInterval(petIntervals[pet.id]);
                    }
                }, 30000);
            } else if (petName === 'Khủng Long') {
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id)) {
                        const randomPet = pets[Math.floor(Math.random() * pets.length)];
                        ownedPets.push(randomPet.name);
                        addNotification(`🦖 Khủng Long mang về 1 ${randomPet.name}!`);
                        renderInventory();
                        saveGameState();
                    } else {
                        clearInterval(petIntervals[pet.id]);
                    }
                }, 75000);
            } else if (petName === 'Cú') {
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id) && currentEvent?.effect === 'night' && plantedCrops.length > 0) {
                        plantedCrops.forEach(plant => {
                            if (Math.random() < 0.40 && !plant.owl) {
                                plant.owl = true;
                                addNotification(`🦉 Cú tới chơi khiến ${plant.item.name} nhiễm cú tới chơi! (x2 giá trị)`);
                            }
                        });
                        renderGarden();
                        saveGameState();
                    } else if (!plantedCrops.length) {
                        addNotification(`🦉 Cú không tìm thấy cây để nhiễm!`);
                    }
                }, 10000);
            } else if (petName === 'Zombie Kid') {
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id) && plantedCrops.length > 0) {
                        const randomIndex = Math.floor(Math.random() * plantedCrops.length);
                        plantedCrops[randomIndex].zombie = true;
                        addNotification(`🧟‍♂️ Zombie Kid đã biến ${plantedCrops[randomIndex].item.name} thành zombie!`);

                        // Removed the plant removal logic here
                        // if (Math.random() < 0.20 && plantedCrops.length > 1) {
                        //     let treeToRemoveIndex = Math.floor(Math.random() * plantedCrops.length);
                        //     while (treeToRemoveIndex === randomIndex && plantedCrops.length > 1) {
                        //         treeToRemoveIndex = Math.floor(Math.random() * plantedCrops.length);
                        //     }
                        //     const removedTree = plantedCrops.splice(treeToRemoveIndex, 1);
                        //     addNotification(`💀 Zombie Kid đã ăn mất ${removedTree[0].item.name}!`);
                        // }
                        renderGarden();
                        saveGameState();
                    } else if (!plantedCrops.length) {
                        addNotification(`🧟‍♂️ Zombie Kid không tìm thấy cây để tấn công!`);
                    }
                }, 25000);
            } else if (petName === 'Squid') {
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id) && plantedCrops.length > 0) {
                        if (Math.random() < 0.30) {
                            const eligiblePlants = plantedCrops.filter(p => {
                                let eventCount = 0;
                                if (p.frozen) eventCount++;
                                if (p.golden) eventCount++;
                                if (p.pest) eventCount++;
                                if (p.giant) eventCount++;
                                if (p.rainbow) eventCount++;
                                if (p.night) eventCount++;
                                if (p.thunder) eventCount++;
                                if (p.tung) eventCount++;
                                if (p.zombie) eventCount++;
                                if (p.vietJoin) eventCount++;
                                if (p.owl) eventCount++;
                                if (p.chocolate) eventCount++;
                                return eventCount >= 6;
                            });

                            if (eligiblePlants.length > 0) {
                                const randomIndex = Math.floor(Math.random() * eligiblePlants.length);
                                const plant = eligiblePlants[randomIndex];

                                const vietJoinState = plant.vietJoin;
                                plant.frozen = false;
                                plant.golden = false;
                                plant.pest = false;
                                plant.giant = false;
                                plant.rainbow = false;
                                plant.night = false;
                                plant.thunder = false;
                                plant.tung = false;
                                plant.zombie = false;
                                plant.owl = false;
                                plant.chocolate = false;
                                plant.eventAffected = null;
                                plant.vietJoin = vietJoinState;

                                plant.vietJoin = true;
                                plant.permanentViet = true;
                                addNotification(`🦑 Squid đã xóa tất cả sự kiện của ${plant.item.name} và Việt đã tham gia trò chơi vĩnh viễn!`);
                                renderGarden();
                                saveGameState();
                            } else {
                                addNotification(`🦑 Squid không tìm thấy cây nào có đủ 6 sự kiện!`);
                            }
                        }
                    } else {
                        clearInterval(petIntervals[pet.id]);
                    }
                }, 60000);
            } else if (petName === 'Khỉ') { 
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id)) {
                        plantedCrops.forEach(plant => {
                            if (plant.night && !plant.alienLike) {
                                plant.alienLike = true;
                                addNotification(`👽 Khỉ và đêm tối khiến ${plant.item.name} nhiễm người ngoài hành tinh!`);
                            }
                        });
                        renderGarden();
                        saveGameState();
                    } else {
                        clearInterval(petIntervals[pet.id]);
                    }
                }, 10000); 
            } else if (petName === 'T-Rex') { // New T-Rex pet effect
                // T-Rex effect is applied at harvest time (evaluatePlant)
                addNotification(`🦖 T-Rex đã được thả! Cây sẽ cho năng suất cao hơn khi thu hoạch!`);
            } else if (petName === 'Khủng Long 3 Sừng') { // New 3-Horned Dinosaur pet effect
                const baseCooldown = 60000;
                const actualCooldown = pet.cooldownReduction ? 
                    baseCooldown * (1 - pet.cooldownReduction / 100) : baseCooldown;
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id)) {
                        // Copy skill from another random pet in garden
                        const otherPets = plantedPets.filter(p => p.id !== pet.id);
                        if (otherPets.length > 0) {
                            const randomPet = otherPets[Math.floor(Math.random() * otherPets.length)];
                            const effect = randomPet.item.effect;
                            
                            // Execute the copied skill effect
                            if (effect === 'seed' && plantedCrops.length > 0) {
                                const randomCrop = crops[Math.floor(Math.random() * crops.length)];
                                inventory[randomCrop.name] = (inventory[randomCrop.name] || 0) + 1;
                                addNotification(`🦕 Khủng Long 3 Sừng sao chép kỹ năng ${randomPet.item.name} - mang về ${randomCrop.name}!`);
                                renderInventory();
                            } else if (effect === 'golden' && plantedCrops.length > 0) {
                                const randomIndex = Math.floor(Math.random() * plantedCrops.length);
                                plantedCrops[randomIndex].golden = true;
                                addNotification(`🦕 Khủng Long 3 Sừng sao chép kỹ năng ${randomPet.item.name} - hóa vàng ${plantedCrops[randomIndex].item.name}!`);
                                renderGarden();
                            } else if (effect === 'rainbow' && plantedCrops.length > 0) {
                                const randomIndex = Math.floor(Math.random() * plantedCrops.length);
                                plantedCrops[randomIndex].rainbow = true;
                                addNotification(`🦕 Khủng Long 3 Sừng sao chép kỹ năng ${randomPet.item.name} - hóa cầu vồng ${plantedCrops[randomIndex].item.name}!`);
                                renderGarden();
                            } else if (effect === 'money') {
                                const cash = Math.floor(Math.random() * 1500) + 1000;
                                money += cash;
                                document.getElementById('money').textContent = `${money.toLocaleString()}$`;
                                addNotification(`🦕 Khủng Long 3 Sừng sao chép kỹ năng ${randomPet.item.name} - tạo ra ${cash.toLocaleString()}$!`);
                            }
                            saveGameState();
                        } else {
                            addNotification(`🦕 Khủng Long 3 Sừng không có thú cưng nào khác để sao chép kỹ năng!`);
                        }
                    } else {
                        clearInterval(petIntervals[pet.id]);
                    }
                }, actualCooldown);
            } else if (petName === 'Heo Cà Rốt') { // New Carrot Pig pet effect
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id) && plantedCrops.length > 0) {
                        const summerCarrotPlants = plantedCrops.filter(p => p.item.name === 'Cà rốt' && p.eventAffected?.effect === 'summerCarrot');
                        if (summerCarrotPlants.length > 0) {
                            const plantToEat = summerCarrotPlants[Math.floor(Math.random() * summerCarrotPlants.length)];
                            plantedCrops = plantedCrops.filter(p => p.id !== plantToEat.id);
                            addNotification(`🐷🥕 Heo Cà Rốt đã ăn ${plantToEat.item.name}!`);

                            plantedCrops.forEach(plant => {
                                plant.superHarvest = true; // Apply Super Harvest effect
                            });
                            addNotification(`🌟 Tất cả cây còn lại đều được Siêu Thu Hoạch!`);
                            renderGarden();
                            saveGameState();
                        } else {
                            addNotification(`🐷🥕 Heo Cà Rốt không tìm thấy Cà rốt mùa hè để ăn!`);
                        }
                    } else if (!plantedCrops.length) {
                        addNotification(`🐷🥕 Heo Cà Rốt không tìm thấy cây để ăn!`);
                    }
                }, 60000); // Every 60 seconds
            } else if (petName === 'Chuột Xám') {
                // Gray Mouse - passive pet (gives 0.5 exp/s to all pets), increased cooldown
                const baseCooldown = 120000; // 2 minutes - increased cooldown as trade-off for passive benefit
                const actualCooldown = pet.cooldownReduction ? 
                    baseCooldown * (1 + pet.cooldownReduction / 100) : baseCooldown; // Note: + instead of - for passive pets
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id)) {
                        addNotification(`🐭 Chuột Xám đang cung cấp +0.5 exp/s cho tất cả thú cưng!`);
                    } else {
                        clearInterval(petIntervals[pet.id]);
                    }
                }, actualCooldown);
            } else if (petName === 'Chuột Sakura') { // New Sakura Mouse pet effect
                const baseCooldown = 30000;
                const actualCooldown = pet.cooldownReduction ? 
                    baseCooldown * (1 - pet.cooldownReduction / 100) : baseCooldown;
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id) && plantedPets.length > 1) {
                        // Target 1-3 pets randomly (excluding Sakura Mouse itself)
                        const otherPets = plantedPets.filter(p => p.id !== pet.id);
                        const targetCount = Math.min(Math.floor(Math.random() * 3) + 1, otherPets.length);
                        const targetPets = [];
                        
                        for (let i = 0; i < targetCount; i++) {
                            const randomIndex = Math.floor(Math.random() * otherPets.length);
                            const targetPet = otherPets.splice(randomIndex, 1)[0];
                            targetPets.push(targetPet);
                        }
                        
                        targetPets.forEach(targetPet => {
                            // Give +55 exp and 50% skill trigger chance
                            targetPet.experience += 55;
                            
                            // Check for level up
                            const expNeeded = targetPet.level * 100;
                            if (targetPet.experience >= expNeeded) {
                                targetPet.level++;
                                targetPet.experience = 0;
                                addNotification(`🌸 ${targetPet.item.name} lên cấp ${targetPet.level} nhờ nước bọt Sakura!`);
                                
                                // Update cooldown reduction after level up
                                const kgReduction = targetPet.kg * 0.02;
                                const levelReduction = targetPet.level * 0.005;
                                targetPet.cooldownReduction = (kgReduction + levelReduction) * 100;
                            }
                            
                            // 50% chance to trigger their skill immediately
                            if (Math.random() < 0.5) {
                                const effect = targetPet.item.effect;
                                if (effect === 'seed') {
                                    const randomCrop = crops[Math.floor(Math.random() * crops.length)];
                                    inventory[randomCrop.name] = (inventory[randomCrop.name] || 0) + 1;
                                    addNotification(`🌸 Nước bọt Sakura kích hoạt kỹ năng ${targetPet.item.name}!`);
                                    renderInventory();
                                } else if (effect === 'golden' && plantedCrops.length > 0) {
                                    const randomIndex = Math.floor(Math.random() * plantedCrops.length);
                                    plantedCrops[randomIndex].golden = true;
                                    addNotification(`🌸 Nước bọt Sakura kích hoạt kỹ năng ${targetPet.item.name}!`);
                                    renderGarden();
                                } else if (effect === 'money') {
                                    const cash = Math.floor(Math.random() * 1500) + 1000;
                                    money += cash;
                                    document.getElementById('money').textContent = `${money.toLocaleString()}$`;
                                    addNotification(`🌸 Nước bọt Sakura kích hoạt kỹ năng ${targetPet.item.name}!`);
                                }
                            }
                        });
                        
                        addNotification(`🌸 Chuột Sakura nhổ nước bọt lên ${targetPets.length} thú cưng (+55 exp mỗi con)!`);
                        renderGarden();
                        saveGameState();
                    } else {
                        addNotification(`🌸 Chuột Sakura không có thú cưng nào khác để nhổ nước bọt!`);
                    }
                }, actualCooldown);
            } else if (petName === 'Chuột Hamster') {
                // Hamster - passive pet (gives 1 exp/s to all pets), increased cooldown  
                const baseCooldown = 150000; // 2.5 minutes - increased cooldown as trade-off for passive benefit
                const actualCooldown = pet.cooldownReduction ? 
                    baseCooldown * (1 + pet.cooldownReduction / 100) : baseCooldown; // Note: + instead of - for passive pets
                petIntervals[pet.id] = setInterval(() => {
                    if (plantedPets.some(p => p.id === pet.id)) {
                        addNotification(`🐹 Chuột Hamster đang cung cấp +1 exp/s cho tất cả thú cưng!`);
                    } else {
                        clearInterval(petIntervals[pet.id]);
                    }
                }, actualCooldown);
            }
        };

        const evaluatePlant = (plantId, type) => {
            let plant = type === 'crop' ? plantedCrops.find(p => p.id === plantId) : plantedPets.find(p => p.id === plantId);
            if (plant && plant.isReady) {
                let yieldWeight = plant.yieldWeight;
                let earnings = yieldWeight * plant.item.multiplier * (plant.item.price < 7000 ? 7 : 5);
                let multiplier = 1;
                let eventNote = '';

                if (plant.frozen) {
                    multiplier *= 2;
                    eventNote += ' (Băng giá x2)';
                }
                if (plant.golden) {
                    multiplier *= 5;
                    eventNote += ' (Vàng x5)';
                }
                if (plant.rainbow) {
                    multiplier *= 20;
                    eventNote += ' (Cầu vồng x20)';
                }
                if (plant.night) {
                    multiplier *= 2;
                    eventNote += ' (Nhiễm Đêm x2)';
                }
                if (plant.thunder) {
                    multiplier *= 3;
                    eventNote += ' (Sét đánh x3)';
                }
                if (plant.tung && type === 'crop') {
                    multiplier *= 4;
                    eventNote += ' (Tung Tung Sahur x4)';
                }
                if (plant.zombie && type === 'crop') {
                    multiplier *= 2;
                    eventNote += ' (Zombie x2)';
                }
                if (plant.pest && type === 'crop') {
                    multiplier *= 0.5;
                    eventNote += ' (Sâu bọ x0.5)';
                }
                // Removed giant multiplier from here as per request
                // if (plant.giant && type === 'crop') {
                //     multiplier *= 3;
                //     eventNote += ' (Khổng lồ x3)';
                // }
                if (plant.patriot && type === 'crop') {
                    multiplier *= 1.5;
                    eventNote += ' (Yêu Nước x1.5)';
                }
                if (plant.vietJoin && type === 'crop') {
                    multiplier *= 60;
                    eventNote += ' (Việt Tham Gia x60)';
                }
                if (plant.owl && type === 'crop') {
                    multiplier *= 2;
                    eventNote += ' (Cú tới chơi x2)';
                }
                if (plant.chocolate && type === 'crop') {
                    multiplier *= 4;
                    eventNote += ' (Chocolate x4)';
                }
                if (plant.meteorShower && type === 'crop') { 
                    multiplier *= 6;
                    eventNote += ' (Mưa Sao Băng x6)';
                }
                if (plant.alienLike && type === 'crop') { 
                    multiplier *= 3;
                    eventNote += ' (Người Ngoài Hành Tinh x3)';
                }
                if (plant.blackhole && type === 'crop') { 
                    multiplier *= 45;
                    eventNote += ' (Hố Đen x45)';
                }
                if (plant.superHarvest && type === 'crop') { // New Super Harvest multiplier
                    multiplier *= 4;
                    eventNote += ' (Siêu Thu Hoạch x4)';
                }
                if (plant.eventAffected && plant.eventAffected?.effect === 'growth' && type === 'crop') {
                    eventNote += ' (Mưa tăng trưởng)';
                    // REMOVED: setTimeout to reset eventAffected for 'growth'
                }
                if (currentEvent?.effect === 'marketboom') {
                    multiplier *= 1.5;
                    eventNote += ' (Thị trường sốt x1.5)';
                }
                if (currentEvent?.effect === 'petboost' && type === 'pet') {
                    multiplier *= 1.2;
                    eventNote += ' (Pet nổi loạn x1.2)';
                }
                if (currentEvent?.effect === 'chocolate' && type === 'crop') {
                    multiplier *= 4;
                    eventNote += ' (Sự kiện Chocolate x4)';
                }
                if (currentEvent?.effect === 'summerCarrot' && plant.item.name === 'Cà rốt') { // Summer Carrot event multiplier
                    multiplier *= 2;
                    eventNote += ' (Cà rốt Mùa Hè x2)';
                }
                if (type === 'pet') {
                    eventNote += ' (Thú cưng giá trị đặc biệt)';
                }
                if (hasPet('Khỉ') && type === 'crop') {
                    const monkeyPet = plantedPets.find(p => p.item.name === 'Khỉ');
                    if (monkeyPet && monkeyPet.isUpgraded) {
                        multiplier *= monkeyPet.item.upgrade.multiplier;
                        eventNote += ` (${monkeyPet.item.upgrade.name} x${monkeyPet.item.upgrade.multiplier})`;
                    } else {
                        multiplier *= 1.5;
                        eventNote += ' (Khỉ x1.5)';
                    }
                }
                if (hasPet('T-Rex') && type === 'crop') { // T-Rex pet multiplier
                    multiplier *= 1.25;
                    eventNote += ' (T-Rex x1.25)';
                }


                earnings *= multiplier;
                pendingSell = { plantId, type, yieldWeight, earnings, eventNote, itemName: plant.item.name };
                document.getElementById('sell-crop-info').textContent = `${plant.item.name} (${type === 'crop' ? yieldWeight + 'kg' : '1 con'})`;
                document.getElementById('sell-price').textContent = `Giá bán: ${Math.floor(earnings).toLocaleString()}$ ${eventNote}`;
                document.getElementById('sell-confirm-modal').classList.remove('hidden');
            }
        };

        const confirmSell = () => {
            if (pendingSell) {
                const { plantId, type, earnings, eventNote, itemName, yieldWeight } = pendingSell;
                let plant = type === 'crop' ? plantedCrops.find(p => p.id === plantId) : plantedPets.find(p => p.id === plantId);
                if (plant) {
                    // Only 'Cây Xương Ai Cập' gives items on sell, not 'Cây Xương Saundice'
                    if (itemName === 'Cây Xương Ai Cập') {
                        inventory[itemName] = (inventory[itemName] || 0) + yieldWeight;
                        addNotification(`${itemName}: +${yieldWeight}kg Xương Ai Cập!`);
                    } else {
                        money += Math.floor(earnings);
                        document.getElementById('money').textContent = `${money.toLocaleString()}$`;
                        addNotification(`${plant.item.name}: +${Math.floor(earnings).toLocaleString()}$ ${eventNote}`);
                    }
                    
                    if (type === 'crop') {
                        plantedCrops = plantedCrops.filter(p => p.id !== plantId);
                        if (itemName === 'Cà rốt' && currentEvent?.effect === 'summerCarrot') {
                            summerCarrotQuestProgress.harvestCarrots++;
                            updateSummerCarrotQuestProgress(); // Update quest progress immediately
                        }
                    } else {
                        clearInterval(petIntervals[plantId]);
                        delete petIntervals[plantId];
                        plantedPets = plantedPets.filter(p => p.id !== plantId);
                    }
                    
                    renderGarden();
                    document.getElementById('sell-confirm-modal').classList.add('hidden');
                    pendingSell = null;
                    saveGameState();
                }
            }
        };

        const cancelSell = () => {
            document.getElementById('sell-confirm-modal').classList.add('hidden');
            pendingSell = null;
        };

        let wheelSketch = null;
        let wheelAngle = 0;
        let spinning = false;
        let spinSpeed = 0;
        let targetAngle = 0;
        let spinDuration = 3000;

        const startWheelSpinAnimation = (finalRewardIndex) => {
            if (wheelSketch) {
                spinning = true;
                spinSpeed = Math.random() * 0.3 + 0.15;
                const segmentAngle = 360 / wheelRewards.length;
                targetAngle = 360 * 5 + (finalRewardIndex * segmentAngle) + (Math.random() * segmentAngle * 0.8 - segmentAngle * 0.4);

                const wheelCanvasContainer = document.getElementById('wheel-canvas-container');
                wheelCanvasContainer.classList.add('active');

                setTimeout(() => {
                    spinning = false;
                    spinSpeed = 0;
                }, spinDuration);
            }
        };

        const wheelP5Sketch = (sketch) => {
            const wheelRadius = 150;
            const centerX = 200;
            const centerY = 200;
            const segmentAngle = 360 / wheelRewards.length;

            sketch.setup = () => {
                sketch.createCanvas(400, 400);
                sketch.angleMode(sketch.DEGREES);
                sketch.frameRate(60);
                sketch.noSmooth(); // Added to potentially fix line rendering issues
            };

            sketch.draw = () => {
                sketch.background(255);
                sketch.translate(centerX, centerY);

                if (spinning) {
                    wheelAngle += spinSpeed * 10;
                    spinSpeed *= 0.98;
                    if (spinSpeed < 0.005) {
                        spinning = false;
                    }
                }
                
                wheelAngle = wheelAngle % 360;

                sketch.rotate(wheelAngle);

                for (let i = 0; i < wheelRewards.length; i++) {
                    const hue = (i * (360 / wheelRewards.length)) % 360;
                    sketch.colorMode(sketch.HSB);
                    sketch.fill(hue, 80, 90);
                    sketch.stroke(0);
                    sketch.strokeWeight(1);

                    sketch.arc(0, 0, wheelRadius * 2, wheelRadius * 2, i * segmentAngle, (i + 1) * segmentAngle, sketch.PIE);
                    
                    sketch.push();
                    sketch.rotate(i * segmentAngle + segmentAngle / 2);
                    sketch.fill(0);
                    sketch.textAlign(sketch.CENTER, sketch.CENTER);
                    sketch.textSize(14);
                    sketch.text(wheelRewards[i].reward.name, wheelRadius * 0.6, 0);
                    sketch.pop();
                }

                sketch.push();
                sketch.rotate(-wheelAngle);
                sketch.fill(255, 0, 0);
                sketch.noStroke();
                sketch.triangle(wheelRadius + 10, 0, wheelRadius + 30, -10, wheelRadius + 30, 10);
                sketch.pop();
            };
        };

        const spinWheel = () => {
            if (wheelOpen && !spinning) {
                const random = Math.random();
                let cumulativeChance = 0;
                let reward = null;
                let rewardIndex = -1;

                for (let i = 0; i < wheelRewards.length; i++) {
                    const item = wheelRewards[i];
                    cumulativeChance += item.chance;
                    if (random < cumulativeChance) {
                        reward = item.reward;
                        rewardIndex = i;
                        break;
                    }
                }

                if (!reward && wheelRewards.length > 0) {
                    reward = wheelRewards[wheelRewards.length - 1].reward;
                    rewardIndex = wheelRewards.length - 1;
                    console.warn("Fallback: No reward selected by chance, defaulting to last item:", reward.name);
                }

                if (reward) {
                    // Ensure previous sketch is removed before creating a new one
                    if (wheelSketch) {
                        wheelSketch.remove();
                        wheelSketch = null;
                    }
                    wheelSketch = new p5(wheelP5Sketch, document.getElementById('wheel-canvas-container'));

                    startWheelSpinAnimation(rewardIndex);

                    setTimeout(() => {
                        if (reward.name === 'special') {
                            addNotification(`🎉 Bạn nhận được phần thưởng đặc biệt!`);
                        } else {
                            inventory[reward.name] = (inventory[reward.name] || 0) + reward.count;
                            document.getElementById('spin-result').textContent = `Chúc mừng! Bạn nhận được ${reward.count} ${reward.name}!`;
                            addNotification(`🎉 Nhận ${reward.count} ${reward.name} từ vòng quay!`);
                            renderInventory();
                        }
                        setTimeout(() => {
                            document.getElementById('spin-wheel-modal').classList.add('hidden');
                            document.getElementById('spin-result').textContent = '';
                            document.getElementById('wheel-canvas-container').classList.remove('active');
                            if (wheelSketch) { // Ensure sketch is removed when modal closes
                                wheelSketch.remove();
                                wheelSketch = null;
                            }
                            wheelOpen = false;
                            wheelTimer = 3 * 60;
                            wheelOpenDuration = 15;
                            document.getElementById('seed-progress').textContent = `Vòng Quay: ${Math.ceil(wheelTimer)}s`;
                        }, 1500);
                    }, spinDuration);
                } else {
                    addNotification('Không thể chọn phần thưởng. Vòng quay có thể trống!');
                    console.error("Wheel rewards array is empty or logic error preventing selection.");
                }
                saveGameState();
            } else if (spinning) {
                addNotification('Vòng quay đang quay!');
            } else {
                addNotification('Vòng quay chưa sẵn sàng!');
            }
        };

        const startSnakeGame = () => {
            if (snakeGameActive) return;
            snakeGameActive = true;
            snakeGameTimer = 30;
            snakeGameScore = 0;
            document.getElementById('snake-game-timer').textContent = `${snakeGameTimer}s`;
            document.getElementById('snake-game-score').textContent = `Điểm: ${snakeGameScore}`;
            document.getElementById('snake-game-modal').classList.remove('hidden');
            document.getElementById('snake-canvas-container').classList.add('active');

            const snakeGame = (sketch) => {
                let snake = [{ x: 10, y: 10 }];
                let food = { x: 15, y: 15 };
                let dir = { x: 1, y: 0 };
                let gameOver = false;

                sketch.setup = () => {
                    sketch.createCanvas(400, 400);
                    sketch.frameRate(10);
                    spawnFood();
                };

                const spawnFood = () => {
                    food.x = Math.floor(Math.random() * 20);
                    food.y = Math.floor(Math.random() * 20);
                    while (snake.some(segment => segment.x === food.x && segment.y === food.y)) {
                        food.x = Math.floor(Math.random() * 20);
                        food.y = Math.floor(Math.random() * 20);
                    }
                };

                sketch.draw = () => {
                    if (gameOver) return;
                    sketch.background(0);
                    sketch.fill(0, 255, 0);
                    snake.forEach(segment => {
                        sketch.rect(segment.x * 20, segment.y * 20, 20, 20);
                    });
                    sketch.fill(255, 0, 0);
                    sketch.rect(food.x * 20, food.y * 20, 20, 20);
                    const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };
                    if (head.x < 0 || head.x >= 20 || head.y < 0 || head.y >= 20) {
                        endSnakeGame(false);
                        return;
                    }
                    if (snake.some(segment => segment.x === head.x && segment.y === head.y)) {
                        endSnakeGame(false);
                        return;
                    }
                    snake.unshift(head);
                    if (head.x === food.x && head.y === food.y) {
                        snakeGameScore += 1;
                        document.getElementById('snake-game-score').textContent = `Điểm: ${snakeGameScore}`;
                        spawnFood();
                    } else {
                        snake.pop();
                    }
                };

                sketch.keyPressed = () => {
                    if (sketch.keyCode === sketch.LEFT_ARROW && dir.x !== 1) {
                        dir = { x: -1, y: 0 };
                    } else if (sketch.keyCode === sketch.RIGHT_ARROW && dir.x !== -1) {
                        dir = { x: 1, y: 0 };
                    } else if (sketch.keyCode === sketch.UP_ARROW && dir.y !== 1) {
                        dir = { x: 0, y: -1 };
                    } else if (sketch.keyCode === sketch.DOWN_ARROW && dir.y !== -1) {
                        dir = { x: 0, y: 1 };
                    }
                };
            };

            snakeGameInstance = new p5(snakeGame, document.getElementById('snake-canvas-container'));

            const timerInterval = setInterval(() => {
                if (!snakeGameActive) {
                    clearInterval(timerInterval);
                    return;
                }
                snakeGameTimer -= 1;
                document.getElementById('snake-game-timer').textContent = `${snakeGameTimer}s`;
                if (snakeGameTimer <= 0) {
                    endSnakeGame(snakeGameScore >= 8);
                    clearInterval(timerInterval);
                }
            }, 1000);
        };

        const endSnakeGame = (success) => {
            if (snakeGameInstance) {
                snakeGameInstance.remove();
                snakeGameInstance = null;
            }
            snakeGameActive = false;
            document.getElementById('snake-canvas-container').classList.remove('active');
            document.getElementById('snake-game-modal').classList.add('hidden');
            if (success) {
                const reward = wheelRewards[Math.floor(Math.random() * wheelRewards.length)].reward;
                inventory[reward.name] = (inventory[reward.name] || 0) + reward.count;
                addNotification(`🎉 Rắn Săn Mồi thắng! Nhận ${reward.count} ${reward.name}!`);
                renderInventory();
            } else {
                addNotification('🐍 Rắn Săn Mồi thất bại! Cố lên lần sau!');
            }
            saveGameState();
        };

        const checkCombinedPlantEffects = () => {
            plantedCrops.forEach(plant => {
                // Rainbow + Chocolate -> Blackhole
                if (plant.rainbow && plant.chocolate && !plant.blackhole) {
                    plant.rainbow = false;
                    plant.chocolate = false;
                    plant.blackhole = true;
                    addNotification(`⚫ ${plant.item.name} bị nhiễm Hố Đen!`);
                }
                // Frozen + Golden -> Meteor Shower
                if (plant.frozen && plant.golden && !plant.meteorShower) {
                    plant.frozen = false;
                    plant.golden = false;
                    plant.meteorShower = true;
                    addNotification(`☄️ ${plant.item.name} bị nhiễm Mưa Sao Băng!`);
                }
            });
            renderGarden();
        };

        const updatePetExperience = () => {
            // Calculate bonus experience from passive pets
            let bonusExp = 0;
            plantedPets.forEach(pet => {
                if (pet.item.effect === 'grayMouse') {
                    bonusExp += 0.5; // Gray Mouse gives 0.5 exp/s to all pets
                } else if (pet.item.effect === 'hamster') {
                    bonusExp += 1.0; // Hamster gives 1 exp/s to all pets
                }
            });
            
            plantedPets.forEach(pet => {
                if (!pet.experience) pet.experience = 0;
                if (!pet.level) pet.level = 1;
                
                // Base experience always stays at 1.15/s regardless of level
                const baseExp = 1.15;
                pet.experience += baseExp + bonusExp;
                
                // Level up system: each level requires 100 experience
                const requiredExp = pet.level * 100;
                if (pet.experience >= requiredExp) {
                    pet.level++;
                    pet.experience = pet.experience - requiredExp;
                    
                    // Recalculate cooldown reduction
                    const kgReduction = pet.kg * 0.02;
                    const levelReduction = pet.level * 0.005;
                    pet.cooldownReduction = (kgReduction + levelReduction) * 100;
                    
                    addNotification(`🎉 ${pet.item.name} đã lên level ${pet.level}!`);
                    renderGarden(); // Update display when pet levels up
                }
            });
            saveGameState();
        };

        const updateTimers = () => {
            const now = Date.now();
            const elapsed = (now - lastFocusTime) / 1000;
            lastFocusTime = now;

            // Shop timers
            shopTimer -= elapsed;
            if (shopTimer <= 0) {
                shopTimer = 60; // Set to 1 minute
                renderShop(); // Re-render to get new items
                addNotification('🛒 Shop đã mở lại!', 'info');
            }
            petShopTimer -= elapsed;
            if (petShopTimer <= 0) {
                petShopTimer = 120; // Set to 2 minutes
                renderPetShop(); // Re-render to get new items
                addNotification('🐾 Pet Shop đã mở lại!', 'info');
            }
            itemShopTimer -= elapsed;
            if (itemShopTimer <= 0) {
                itemShopTimer = 180; // Set to 3 minutes
                renderItemShop(); // Re-render to get new items
                addNotification('🛍️ Gear Shop đã mở lại!', 'info');
            }

            document.getElementById('shop-timer').textContent = `Shop: ${Math.ceil(shopTimer)}s`;
            document.getElementById('pet-shop-timer').textContent = `Pet Shop: ${Math.ceil(petShopTimer)}s`;
            document.getElementById('item-shop-timer').textContent = `Item Shop: ${Math.ceil(itemShopTimer)}s`;

            // Wheel timer
            if (!wheelOpen) {
                wheelTimer -= elapsed;
                if (wheelTimer <= 0) {
                    wheelTimer = 0;
                    wheelOpen = true;
                    document.getElementById('spin-wheel-modal').classList.remove('hidden');
                    document.getElementById('seed-progress').textContent = `Vòng Quay: Mở (${Math.ceil(wheelOpenDuration)}s)`;
                    if (!wheelSketch) { // Only create if it doesn't exist
                        wheelSketch = new p5(wheelP5Sketch, document.getElementById('wheel-canvas-container'));
                    }
                    document.getElementById('wheel-canvas-container').classList.add('active');

                    setTimeout(() => {
                        if (wheelOpen && !spinning) {
                            document.getElementById('spin-wheel-modal').classList.add('hidden');
                            document.getElementById('wheel-canvas-container').classList.remove('active');
                            if (wheelSketch) { // Ensure sketch is removed when modal closes
                                wheelSketch.remove();
                                wheelSketch = null;
                            }
                            wheelOpen = false;
                            wheelTimer = 3 * 60;
                            wheelOpenDuration = 15;
                            document.getElementById('seed-progress').textContent = `Vòng Quay: ${Math.ceil(wheelTimer)}s`;
                        }
                    }, wheelOpenDuration * 1000);
                } else {
                    document.getElementById('seed-progress').textContent = `Vòng Quay: ${Math.ceil(wheelTimer)}s`;
                }
            } else {
                wheelOpenDuration -= elapsed;
                if (wheelOpenDuration <= 0) {
                    if (wheelOpen && !spinning) {
                        document.getElementById('spin-wheel-modal').classList.add('hidden');
                        document.getElementById('wheel-canvas-container').classList.remove('active');
                        if (wheelSketch) { // Ensure sketch is removed when modal closes
                            wheelSketch.remove();
                            wheelSketch = null;
                        }
                        wheelOpen = false;
                        wheelTimer = 3 * 60;
                        wheelOpenDuration = 15;
                        document.getElementById('seed-progress').textContent = `Vòng Quay: ${Math.ceil(wheelOpenDuration)}s`; // Changed to show remaining open duration
                    }
                } else {
                    document.getElementById('seed-progress').textContent = `Vòng Quay: Mở (${Math.ceil(wheelOpenDuration)}s)`;
                }
            }

            // Event timer
            if (currentEvent) {
                eventTimer -= elapsed;
                if (eventTimer <= 0) {
                    const endingEvent = currentEvent;
                    
                    // Show end notifications only for Carrot Harvest and Ancient events
                    if (endingEvent && (endingEvent.effect === 'summerCarrot' || endingEvent.effect === 'ancient')) {
                        addNotification(`Sự kiện ${endingEvent.name} đã kết thúc! Nhiệm vụ chưa hoàn thành đã bị hủy.`);
                        
                        // Reset quest progress for ancient and summer carrot events
                        if (endingEvent.effect === 'ancient') {
                            ancientQuestProgress = { plantSaundiceBoneTreeYield: false, plantSaundiceBoneTreeValue: false, own50Million: false };
                        } else if (endingEvent.effect === 'summerCarrot') {
                            summerCarrotQuestProgress = { buyCarrots: 0, harvestCarrots: 0, goldenCarrot: false };
                        }
                    }
                    
                    currentEvent = null;
                    eventTimer = 0;
                    plantedCrops.forEach(plant => {
                        // Add the ending event to persistent events list (stays with tree forever)
                        if (endingEvent && !plant.persistentEvents.find(e => e.name === endingEvent.name)) {
                            plant.persistentEvents.push({
                                name: endingEvent.name,
                                effect: endingEvent.effect,
                                icon: endingEvent.icon,
                                endTime: Date.now()
                            });
                        }
                        
                        plant.eventAffected = null;
                        if (!plant.permanentViet) {
                            plant.vietJoin = false;
                        }
                        
                        // MUTATIONS STAY FOREVER - DO NOT REMOVE VISUAL EFFECTS WHEN EVENTS END
                        // User requested: Events/mutations must stay with trees forever, not disappear when events end
                        // const temporaryEffects = ['freeze', 'golden', 'rainbow', 'night', 'thunder', 'meteorShower', 'alienLike', 'blackhole'];
                        // if (endingEvent && temporaryEffects.includes(endingEvent.effect)) {
                        //     plant.frozen = false;
                        //     plant.golden = false;
                        //     plant.rainbow = false;
                        //     plant.night = false;
                        //     plant.thunder = false;
                        //     plant.meteorShower = false;
                        //     plant.alienLike = false;
                        //     plant.blackhole = false;
                        // }
                        
                        // Keep other effects permanent unless specifically temporary
                        // plant.pest, plant.giant, plant.tung, plant.zombie, etc. stay as they are
                    });
                    renderEvent(); // This will now hide the event display and clear quest details
                    renderGarden();
                } else {
                    document.getElementById('event-timer').textContent = `Còn lại: ${Math.ceil(eventTimer)}s`;
                    // Always update quest progress in the event display
                    if (currentEvent.effect === 'ancient' || currentEvent.effect === 'summerCarrot') {
                        renderEvent(); // Re-render event to update quest progress in the display
                    }
                }
            } else {
                const random = Math.random();
                let cumulativeChance = 0;
                for (const event of events) {
                    cumulativeChance += event.chance;
                    if (random < cumulativeChance) {
                        currentEvent = event;
                        eventTimer = event.duration;
                        applyEventEffect(event);
                        break;
                    }
                }
                renderEvent(); // Call renderEvent to display the new event and its quests
            }
            checkCombinedPlantEffects(); 
            saveGameState();
        };

        const applyEventEffect = (event) => {
            if (event.effect === 'freeze') {
                plantedCrops.forEach(plant => {
                    if (Math.random() < 0.25 && !plant.frozen) {
                        plant.frozen = true;
                        addNotification(`❄️ ${plant.item.name} bị đóng băng!`);
                    }
                });
            } else if (event.effect === 'golden') {
                if (plantedCrops.length > 0) {
                    const randomIndex = Math.floor(Math.random() * plantedCrops.length);
                    plantedCrops[randomIndex].golden = true;
                    addNotification(`✨ ${plantedCrops[randomIndex].item.name} hóa vàng!`);
                }
            } else if (event.effect === 'pest' && !hasPet('Ếch') && !pestImmunity) { 
                plantedCrops.forEach(plant => {
                    if (Math.random() < 0.3 && !plant.pest) {
                        plant.pest = true;
                        addNotification(`🐛 ${plant.item.name} bị sâu bọ!`);
                    }
                });
            } else if (event.effect === 'rainbow') {
                if (plantedCrops.length > 0) {
                    const randomIndex = Math.floor(Math.random() * plantedCrops.length);
                    plantedCrops[randomIndex].rainbow = true;
                    addNotification(`🌈 ${plantedCrops[randomIndex].item.name} hóa cầu vồng!`);
                }
            } else if (event.effect === 'night') {
                plantedCrops.forEach(plant => {
                    if (Math.random() < 0.4 && !plant.night) {
                        plant.night = true;
                        addNotification(`🌙 ${plant.item.name} nhiễm đêm!`);
                    }
                    if (hasPet('Khỉ') && plant.night && !plant.alienLike) {
                        plant.alienLike = true;
                        addNotification(`👽 Khỉ và đêm tối khiến ${plant.item.name} nhiễm người ngoài hành tinh!`);
                    }
                });
                renderShop();
            } else if (event.effect === 'thunder') {
                plantedCrops.forEach(plant => {
                    if (Math.random() < 0.2 && !plant.thunder) {
                        plant.thunder = true;
                        addNotification(`⚡ ${plant.item.name} bị sét đánh!`);
                    }
                });
            } else if (event.effect === 'zombie' && !hasPet('Cá Sấu') && !zombieImmunity) { 
                plantedCrops.forEach(plant => {
                    // Only apply zombie effect, do not remove plant
                    if (Math.random() < 0.5 && !plant.zombie) {
                        plant.zombie = true;
                        addNotification(`🧟 ${plant.item.name} nhiễm zombie!`);
                    }
                });
            } else if (event.effect === 'vietJoin') {
                plantedCrops.forEach(plant => {
                    plant.vietJoin = true;
                    plant.permanentViet = true; 
                });
                addNotification(`👨‍💻 Việt đã tham gia trò chơi! Tất cả cây x60 giá trị!`);
            } else if (event.effect === 'chocolate') {
                plantedCrops.forEach(plant => {
                    if (Math.random() < 0.5 && !plant.chocolate) {
                        plant.chocolate = true;
                        addNotification(`🍫 ${plant.item.name} nhiễm Chocolate!`);
                    }
                });
            } else if (event.effect === 'meteorShower') { 
                plantedCrops.forEach(plant => {
                    if (Math.random() < 0.10 && !plant.meteorShower) {
                        plant.meteorShower = true;
                        addNotification(`☄️ ${plant.item.name} bị nhiễm mưa sao băng!`);
                    }
                });
            } else if (event.effect === 'alienLike') { 
                plantedCrops.forEach(plant => {
                    if (Math.random() < 0.15 && !plant.alienLike) {
                        plant.alienLike = true;
                        addNotification(`👽 ${plant.item.name} bị nhiễm người ngoài hành tinh!`);
                    }
                });
            } else if (event.effect === 'ancient') { // New ancient event trigger
                // Add Saundice Bone Tree to inventory when ancient event starts
                const saundiceBoneTree = crops.find(c => c.name === 'Cây Xương Saundice');
                if (saundiceBoneTree && !inventory['Cây Xương Saundice']) { // Only add if not already in inventory
                    inventory['Cây Xương Saundice'] = (inventory['Cây Xương Saundice'] || 0) + 1;
                    addNotification(`🦴✨ Bạn đã nhận được 1 Cây Xương Saundice từ Sự Kiện Cổ Đại!`);
                    renderInventory();
                }
            } else if (event.effect === 'summerCarrot') { // New summer carrot event trigger
                // No specific action needed here, quests are tracked separately
            }
            renderGarden();
            saveGameState();
        };

        const showAncientQuestModal = () => {
            document.getElementById('ancient-quest-modal').classList.remove('hidden');
            updateAncientQuestProgress(); // Ensure modal content is up-to-date
        };

        const closeAncientQuestModal = () => {
            document.getElementById('ancient-quest-modal').classList.add('hidden');
        };

        const updateAncientQuestProgress = () => {
            // Update the modal content
            document.getElementById('ancient-quest-1').textContent = ancientQuestProgress.plantSaundiceBoneTreeYield ? '✅' : '❌';
            document.getElementById('ancient-quest-2').textContent = ancientQuestProgress.plantSaundiceBoneTreeValue ? '✅' : '❌';
            document.getElementById('ancient-quest-3').textContent = money >= 50000000 ? '✅' : '❌';
            ancientQuestProgress.own50Million = money >= 50000000; // Update internal state

            // Update the event notification area directly
            if (currentEvent?.effect === 'ancient') {
                const eventQuestDetailsDiv = document.getElementById('event-quest-details');
                eventQuestDetailsDiv.innerHTML = `
                    <ul class="list-disc list-inside">
                        <li>Trồng một Cây Xương Saundice và đạt trên 12kg: <span class="font-semibold">${ancientQuestProgress.plantSaundiceBoneTreeYield ? '✅' : '❌'}</span></li>
                        <li>Trồng một Cây Xương Saundice và giá trị của nó trên 2650 tiền: <span class="font-semibold">${ancientQuestProgress.plantSaundiceBoneTreeValue ? '✅' : '❌'}</span></li>
                        <li>Sở hữu 50,000,000$: <span class="font-semibold">${money >= 50000000 ? '✅' : '❌'}</span></li>
                    </ul>
                `;
            }

            if (ancientQuestProgress.plantSaundiceBoneTreeYield && ancientQuestProgress.plantSaundiceBoneTreeValue && ancientQuestProgress.own50Million && !ancientChestReady) {
                ancientChestReady = true;
                showAncientChestModal();
                addNotification('🎉 Nhiệm vụ Cổ Đại HOÀN THÀNH! Mở rương để nhận thưởng!');
            }
        };

        const showAncientChestModal = () => {
            document.getElementById('ancient-quest-modal').classList.add('hidden'); // Ensure quest modal is hidden
            document.getElementById('ancient-chest-modal').classList.remove('hidden');
            document.getElementById('open-ancient-chest-button').disabled = true;
            ancientChestTimer = 10;
            document.getElementById('ancient-chest-timer').textContent = `Thời gian chờ: ${ancientChestTimer}s`;

            ancientChestInterval = setInterval(() => {
                ancientChestTimer--;
                document.getElementById('ancient-chest-timer').textContent = `Thời gian chờ: ${ancientChestTimer}s`;
                if (ancientChestTimer <= 0) {
                    clearInterval(ancientChestInterval);
                    document.getElementById('open-ancient-chest-button').disabled = false;
                    document.getElementById('ancient-chest-timer').textContent = `Sẵn sàng mở!`;
                }
            }, 1000);
        };

        const openAncientChest = () => {
            if (!ancientChestReady) return;

            const random = Math.random();
            let reward = null;

            if (random < 0.10) { // 10% chance for T-Rex
                reward = pets.find(p => p.name === 'T-Rex');
                ownedPets.push(reward.name);
                addNotification(`🎉 Bạn đã nhận được thú cưng huyền thoại T-Rex!`);
            } else if (random < 0.40) { // 30% chance for Saundice Bone Tree
                reward = crops.find(c => c.name === 'Cây Xương Saundice');
                inventory[reward.name] = (inventory[reward.name] || 0) + 1;
                addNotification(`🎉 Bạn đã nhận được hạt giống Cây Xương Saundice!`);
            } else { // 60% chance for 3-Horned Dinosaur
                reward = pets.find(p => p.name === 'Khủng Long 3 Sừng');
                ownedPets.push(reward.name);
                addNotification(`🎉 Bạn đã nhận được thú cưng Khủng Long 3 Sừng!`);
            }

            ancientChestReady = false;
            ancientQuestProgress = { plantSaundiceBoneTreeYield: false, plantSaundiceBoneTreeValue: false, own50Million: false }; // Reset quests
            closeAncientChestModal();
            renderInventory();
            saveGameState();
        };

        const closeAncientChestModal = () => {
            clearInterval(ancientChestInterval);
            document.getElementById('ancient-chest-modal').classList.add('hidden');
            document.getElementById('open-ancient-chest-button').disabled = true;
        };

        const showSummerCarrotQuestModal = () => {
            document.getElementById('summer-carrot-quest-modal').classList.remove('hidden');
            updateSummerCarrotQuestProgress(); // Ensure modal content is up-to-date
        };

        const closeSummerCarrotQuestModal = () => {
            document.getElementById('summer-carrot-quest-modal').classList.add('hidden');
        };

        const updateSummerCarrotQuestProgress = () => {
            // Update the modal content
            document.getElementById('summer-carrot-quest-1').textContent = summerCarrotQuestProgress.buyCarrots >= 25 ? '✅' : `❌ (${summerCarrotQuestProgress.buyCarrots}/25)`;
            document.getElementById('summer-carrot-quest-2').textContent = summerCarrotQuestProgress.harvestCarrots >= 25 ? '✅' : `❌ (${summerCarrotQuestProgress.harvestCarrots}/25)`;
            document.getElementById('summer-carrot-quest-3').textContent = summerCarrotQuestProgress.goldenCarrot ? '✅' : '❌';

            // Update the event notification area directly
            if (currentEvent?.effect === 'summerCarrot') {
                const eventQuestDetailsDiv = document.getElementById('event-quest-details');
                eventQuestDetailsDiv.innerHTML = `
                    <ul class="list-disc list-inside">
                        <li>Mua 25 Cà rốt: <span class="font-semibold">${summerCarrotQuestProgress.buyCarrots >= 25 ? '✅' : `❌ (${summerCarrotQuestProgress.buyCarrots}/25)`}</span></li>
                        <li>Thu hoạch 25 Cà rốt: <span class="font-semibold">${summerCarrotQuestProgress.harvestCarrots >= 25 ? '✅' : `❌ (${summerCarrotQuestProgress.harvestCarrots}/25)`}</span></li>
                        <li>Sở hữu 1 Cà rốt vàng: <span class="font-semibold">${summerCarrotQuestProgress.goldenCarrot ? '✅' : '❌'}</span></li>
                    </ul>
                `;
            }

            if (summerCarrotQuestProgress.buyCarrots >= 25 && summerCarrotQuestProgress.harvestCarrots >= 25 && summerCarrotQuestProgress.goldenCarrot) {
                // Reward the player
                addNotification('🎉 Hoàn thành nhiệm vụ Cà rốt mùa hè!');
                // 5 Level 1 Water Fountains
                inventory['Vòi phun nước cấp 1'] = (inventory['Vòi phun nước cấp 1'] || 0) + 5;
                addNotification('Bạn nhận được 5 Vòi phun nước cấp 1!');
                
                // Enhanced reward: 2% chance for Super Growth Big Tree Spray (30% x30% kg) (100% for 1 Super Growth event tree)
                if (Math.random() < 0.02) {
                    inventory['Super Growth Big Tree Spray'] = (inventory['Super Growth Big Tree Spray'] || 0) + 1;
                    addNotification('🌟 BÁN HIẾM! Bạn nhận được 1 Super Growth Big Tree Spray (30% x30% kg)!');
                }
                
                // Carrot Pig pet
                ownedPets.push('Heo Cà Rốt');
                addNotification('Bạn nhận được thú cưng Heo Cà Rốt!');

                // Reset quests
                summerCarrotQuestProgress = { buyCarrots: 0, harvestCarrots: 0, goldenCarrot: false };
                closeSummerCarrotQuestModal(); // Close the modal if it's open
                renderInventory();
                saveGameState();
            }
        };


        const showNewsPoll = () => {
            const poll = newsPolls[0];
            document.getElementById('poll-title').textContent = 'Tin Tức & Bình Chọn';
            document.getElementById('poll-question').textContent = poll.question;
            document.getElementById('poll-options').innerHTML = poll.options.map(option => `
                <button onclick="submitPoll('${option}', '${poll.reward.name}', ${poll.reward.count}, '${poll.special || ''}')" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200 w-full">${option}</button>
            `).join('');
            document.getElementById('poll-reward').textContent = poll.special ? '' : `Thưởng: ${poll.reward.count} ${poll.reward.name}`;
            if (poll.special === 'muile') {
                document.getElementById('poll-money').textContent = `Số tiền hiện tại: ${money.toLocaleString()}$`;
                document.getElementById('poll-money').classList.remove('hidden');
            } else {
                document.getElementById('poll-money').classList.add('hidden');
            }
            document.getElementById('news-poll-modal').classList.remove('hidden');
        };

        const submitPoll = (option, rewardName, rewardCount, special) => {
            if (special === 'muile') {
                if (option === 'Đồng ý') {
                    const moneyTaken = Math.floor(money * 0.5);
                    money -= moneyTaken;
                    document.getElementById('money').textContent = `${money.toLocaleString()}$`;

                    if (Math.random() < 0.5) {
                        addNotification('💸 Mui Lê lấy 50% tiền của bạn và chạy mất!');
                    } else {
                        const payback = moneyTaken * 5;
                        money += payback;
                        document.getElementById('money').textContent = `${money.toLocaleString()}$`;
                        addNotification(`💰 Mui Lê trả lại x5 số tiền đã lấy! (+${payback.toLocaleString()}$)`);
                    }
                } else {
                    addNotification('😎 Bạn từ chối Mui Lê!');
                }
            } else {
                inventory[rewardName] = (inventory[rewardName] || 0) + rewardCount;
                addNotification(`🎉 Nhận ${rewardCount} ${rewardName} từ bình chọn!`);
                renderInventory();
            }
            document.getElementById('news-poll-modal').classList.add('hidden');
            saveGameState();
        };

        const showUpgradePetModal = (petName) => {
            const pet = pets.find(p => p.name === petName);
            if (!pet || !pet.upgrade) return;

            pendingUpgradePet = pet;
            document.getElementById('upgrade-pet-info').textContent = `Bạn muốn nâng cấp ${pet.name} lên ${pet.upgrade.name}?`;
            document.getElementById('pet-upgrade-modal').classList.remove('hidden');
        };

        const confirmUpgradePet = () => {
            if (!pendingUpgradePet) return;

            const pet = pendingUpgradePet;
            const upgradeCost = pet.upgrade.cost;
            const boneTreeName = 'Cây Xương Ai Cập';
            const requiredBoneTreeCount = 1;

            if (money >= upgradeCost && inventory[boneTreeName] && inventory[boneTreeName] >= requiredBoneTreeCount) {
                money -= upgradeCost;
                inventory[boneTreeName] -= requiredBoneTreeCount;
                if (inventory[boneTreeName] === 0) delete inventory[boneTreeName];

                upgradedPets[pet.name] = true;

                plantedPets.forEach(p => {
                    if (p.item.name === pet.name) {
                        p.isUpgraded = true;
                    }
                });

                addNotification(`🎉 Nâng cấp ${pet.name} lên ${pet.upgrade.name} thành công!`);
                document.getElementById('money').textContent = `${money.toLocaleString()}$`;
                renderInventory();
                renderGarden();
                saveGameState();
            } else {
                addNotification('Không đủ tiền hoặc Cây Xương Ai Cập để nâng cấp!');
            }
            cancelUpgradePet();
        };

        const cancelUpgradePet = () => {
            document.getElementById('pet-upgrade-modal').classList.add('hidden');
            pendingUpgradePet = null;
        };

        const saveGameState = () => {
            if (!currentUser) return;

            const state = {
                money,
                inventory,
                ownedPets,
                plantedCrops,
                plantedPets,
                shopTimer,
                petShopTimer,
                itemShopTimer,
                currentEvent,
                eventTimer,
                wheelTimer,
                wheelOpen,
                wheelOpenDuration,
                discountActive,
                upgradedPets,
                commandsUsed: users[currentUser].commandsUsed || {},
                zombieImmunity,
                pestImmunity,
                ancientQuestProgress, // Save new quest progress
                ancientChestReady,
                summerCarrotQuestProgress, // Save new quest progress
                maxGardenSlots, // Save garden slot count
                pendingEvolutionPet // Save pending evolution pet
            };
            users[currentUser].gameState = state;
            localStorage.setItem('users', JSON.stringify(users));
        };

        const loadGameState = () => {
            if (!currentUser) { 
                return;
            }

            if (!users[currentUser] || !users[currentUser].gameState) {
                money = 100;
                inventory = {};
                ownedPets = [];
                plantedCrops = [];
                plantedPets = [];
                shopTimer = 60; // Set to 1 minute
                petShopTimer = 120; // Set to 2 minutes
                itemShopTimer = 180; // Set to 3 minutes
                currentEvent = null;
                eventTimer = 0;
                wheelTimer = 3 * 60;
                wheelOpen = false;
                wheelOpenDuration = 15;
                discountActive = false;
                upgradedPets = { 'Khỉ': false, 'Rồng': false, 'Voi Mamut': false };
                users[currentUser].commandsUsed = {};
                zombieImmunity = false;
                pestImmunity = false;
                ancientQuestProgress = { plantSaundiceBoneTreeYield: false, plantSaundiceBoneTreeValue: false, own50Million: false };
                ancientChestReady = false;
                summerCarrotQuestProgress = { buyCarrots: 0, harvestCarrots: 0, goldenCarrot: false };
                maxGardenSlots = 2; // Default starting slots
                pendingEvolutionPet = null; // No pending evolution
                addNotification('Bắt đầu trò chơi mới!');
            } else {
                const state = users[currentUser].gameState;
                money = state.money || 100;
                inventory = state.inventory || {};
                ownedPets = state.ownedPets || [];
                plantedCrops = state.plantedCrops || [];
                plantedPets = state.plantedPets || [];
                shopTimer = state.shopTimer || 60; // Set to 1 minute
                petShopTimer = state.petShopTimer || 120; // Set to 2 minutes
                itemShopTimer = state.itemShopTimer !== undefined ? state.itemShopTimer : 180; // Set to 3 minutes
                currentEvent = state.currentEvent || null;
                eventTimer = state.eventTimer || 0;
                wheelTimer = state.wheelTimer !== undefined ? state.wheelTimer : (3 * 60);
                wheelOpen = state.wheelOpen || false;
                wheelOpenDuration = state.wheelOpenDuration !== undefined ? state.wheelOpenDuration : 15;
                discountActive = state.discountActive || false;
                upgradedPets = state.upgradedPets || { 'Khỉ': false, 'Rồng': false, 'Voi Mamut': false };
                users[currentUser].commandsUsed = state.commandsUsed || {};
                zombieImmunity = state.zombieImmunity || false;
                pestImmunity = state.pestImmunity || false;
                ancientQuestProgress = state.ancientQuestProgress || { plantSaundiceBoneTreeYield: false, plantSaundiceBoneTreeValue: false, own50Million: false };
                ancientChestReady = state.ancientChestReady || false;
                
                // Add backwards compatibility for existing pets (kg and level system)
                plantedPets.forEach(pet => {
                    if (!pet.kg) {
                        pet.kg = Math.random() < 0.9 ? Math.random() * 5 : (Math.random() * 10) + 5;
                        pet.kg = Math.round(pet.kg * 10) / 10;
                    }
                    if (!pet.level) {
                        pet.level = 1;
                    }
                    if (pet.experience === undefined) {
                        pet.experience = 0;
                    }
                    if (pet.cooldownReduction === undefined) {
                        const kgReduction = pet.kg * 0.02;
                        const levelReduction = pet.level * 0.005;
                        pet.cooldownReduction = (kgReduction + levelReduction) * 100;
                    }
                    if (pet.evolved === undefined) {
                        pet.evolved = false; // Default to not evolved
                    }
                    if (pet.cooldownTimer === undefined) {
                        pet.cooldownTimer = 0; // Initialize cooldown timer
                    }
                });
                
                // Add backwards compatibility for existing plants (persistent events system)
                plantedCrops.forEach(plant => {
                    if (!plant.persistentEvents) {
                        plant.persistentEvents = [];
                    }
                });
                summerCarrotQuestProgress = state.summerCarrotQuestProgress || { buyCarrots: 0, harvestCarrots: 0, goldenCarrot: false };
                maxGardenSlots = state.maxGardenSlots || 2; // Default to 2 slots if not saved
                pendingEvolutionPet = state.pendingEvolutionPet || null; // Load pending evolution

                addNotification(`Chào mừng trở lại, ${currentUser}!`);
            }

            document.getElementById('money').textContent = `${money.toLocaleString()}$`;
            document.getElementById('seed-progress').textContent = `Vòng Quay: ${Math.ceil(wheelTimer)}s`;
            document.getElementById('item-shop-timer').textContent = `Item Shop: ${Math.ceil(itemShopTimer)}s`;
            renderInventory();
            renderShop(); 
            renderPetShop();
            renderItemShop();
            renderGarden();
            renderEvent(); // Call renderEvent here to show event and quest modal if active
            plantedPets.forEach(pet => setupPetEffect(pet));
        };

        const checkDiscount = () => {
            if (plantedCrops.some(p => p.item.effect === 'discount')) {
                discountActive = true;
                addNotification('💩 Cây Cứt giảm giá 50%!');
            } else {
                discountActive = false;
            }
            renderShop();
            renderPetShop();
            renderItemShop();
        };

        const executeCommand = () => {
            const commandInput = document.getElementById('command-input');
            const command = commandInput.value.trim().toUpperCase();
            commandInput.value = '';

            if (!currentUser) {
                addNotification('Vui lòng đăng nhập để sử dụng lệnh.');
                return;
            }

            if (users[currentUser].commandsUsed && users[currentUser].commandsUsed[command]) {
                addNotification(`Lệnh "${command}" đã được sử dụng rồi!`);
                return;
            }

            switch (command) {
                case 'NEWPLAYER':
                    inventory['Cây Noel'] = (inventory['Cây Noel'] || 0) + 3;
                    money += 50000;
                    addNotification('Nhận 3 Cây Noel và 50,000$!');
                    users[currentUser].commandsUsed[command] = true;
                    break;
                case 'GROWAGAYISBEST':
                    const randomCrop = crops[Math.floor(Math.random() * crops.length)];
                    inventory[randomCrop.name] = (inventory[randomCrop.name] || 0) + 1;
                    addNotification(`Nhận 1 ${randomCrop.name}! Việt đã tham gia trò chơi!`);
                    plantedCrops.forEach(plant => {
                        plant.vietJoin = true;
                        plant.permanentViet = true;
                    });
                    users[currentUser].commandsUsed[command] = true;
                    break;
                case 'ADMINGOOD':
                    inventory['Vòi phun nước cấp 1'] = (inventory['Vòi phun nước cấp 1'] || 0) + 7;
                    inventory['Vòi phun nước cấp 2'] = (inventory['Vòi phun nước cấp 2'] || 0) + 5;
                    inventory['Vòi phun nước cấp 3'] = (inventory['Vòi phun nước cấp 3'] || 0) + 4;
                    inventory['Vòi phun nước Chocolate'] = (inventory['Vòi phun nước Chocolate'] || 0) + 5;
                    zombieImmunity = true;
                    pestImmunity = true;
                    addNotification('Nhận vật phẩm admin! Zombie và sâu bọ sẽ không xuất hiện!');
                    users[currentUser].commandsUsed[command] = true;
                    break;
                default:
                    addNotification('Lệnh không hợp lệ!');
                    break;
            }
            renderInventory();
            renderGarden();
            saveGameState();
        };

        function handleAuth(type) {
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                addNotification('Tên người dùng và mật khẩu không được để trống.');
                return;
            }
            if (username.length > 14 || password.length > 14) {
                addNotification('Tên người dùng và mật khẩu tối đa 14 ký tự.');
                return;
            }

            if (type === 'register') {
                if (users[username]) {
                    addNotification('Tên người dùng đã tồn tại.');
                    return;
                }
                users[username] = { password: password, gameState: null, commandsUsed: {} };
                localStorage.setItem('users', JSON.stringify(users));
                addNotification('Đăng ký thành công! Bạn có thể đăng nhập ngay.');
                usernameInput.value = '';
                passwordInput.value = '';
                document.getElementById('auth-title').textContent = 'Đăng Nhập';
                currentAuthMode = 'login';
                return;
            }

            if (type === 'login') {
                if (users[username] && users[username].password === password) {
                    currentUser = username;
                    document.getElementById('auth-modal').classList.add('hidden');
                    loadGameState();
                    setInterval(updateTimers, 1000);
                    setInterval(showNewsPoll, 30000);
                    setInterval(checkDiscount, 5000);
                    setInterval(updatePetExperience, 1000);
                    setInterval(() => {
                        renderGarden();
                        updatePetCooldowns();
                    }, 1000); // Update pet display every second to show experience progress and cooldowns
                    window.addEventListener('focus', () => {
                        lastFocusTime = Date.now();
                    });
                    if (wheelOpen) {
                        // Ensure previous sketch is removed before creating a new one
                        if (wheelSketch) {
                            wheelSketch.remove();
                            wheelSketch = null;
                        }
                        wheelSketch = new p5(wheelP5Sketch, document.getElementById('wheel-canvas-container'));
                        document.getElementById('wheel-canvas-container').classList.add('active');
                    }
                    addNotification(`Đăng nhập thành công! Chào mừng ${currentUser}!`);
                } else {
                    addNotification('Tên người dùng hoặc mật khẩu không đúng.');
                }
            }
        }

        function handleKeyPress(event, mode) {
            if (event.key === 'Enter') {
                handleAuth(mode);
            }
        }

        function showPlayerList() {
            if (!currentUser) {
                addNotification('Vui lòng đăng nhập để xem danh sách người chơi.');
                return;
            }
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            const usernames = Object.keys(users).filter(u => u !== currentUser);
            if (usernames.length === 0) {
                playerList.innerHTML = '<li class="p-2 text-center text-gray-500">Không có người chơi nào khác.</li>';
            } else {
                usernames.forEach(username => {
                    const li = document.createElement('li');
                    li.className = 'p-2 cursor-pointer hover:bg-gray-200 rounded flex justify-between items-center';
                    li.textContent = username;
                    // Modified to view garden instead of sending gift
                    const btn = document.createElement('button');
                    btn.textContent = 'Xem vườn';
                    btn.className = 'bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 text-sm';
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        viewPlayerGarden(username);
                    };
                    li.appendChild(btn);
                    playerList.appendChild(li);
                });
            }
            document.getElementById('player-list-modal').classList.remove('hidden');
        }

        function closePlayerList() {
            document.getElementById('player-list-modal').classList.add('hidden');
        }

        // Placeholder for viewing another player's garden (requires server-side implementation)
        function viewPlayerGarden(username) {
            addNotification(`Đang cố gắng xem vườn của ${username}... (Tính năng này yêu cầu máy chủ để hoạt động đầy đủ!)`);
            // In a real application, you would send a request to the server here
            // to fetch the garden state of 'username' and then render it in a new modal.
        }

        // Chat functions (placeholder, requires server-side implementation)
        function openChat() {
            if (!currentUser) {
                addNotification('Vui lòng đăng nhập để trò chuyện.');
                return;
            }
            document.getElementById('chat-modal').classList.remove('hidden');
            addNotification('Tính năng trò chuyện yêu cầu máy chủ để hoạt động đầy đủ!');
            // In a real application, you would connect to a WebSocket server here
            // and load past messages.
        }

        function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            if (message) {
                const chatMessages = document.getElementById('chat-messages');
                const newMessage = document.createElement('div');
                newMessage.textContent = `${currentUser}: ${message}`;
                chatMessages.appendChild(newMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
                chatInput.value = '';
                addNotification(`Tin nhắn "${message}" đã được gửi! (Chỉ hiển thị cục bộ)`);
                // In a real application, you would send this message to the server
                // via WebSocket.
            }
        }

        function closeChat() {
            document.getElementById('chat-modal').classList.add('hidden');
        }

        let selectedPetId = null;

        const showPetDetails = (petId) => {
            const pet = plantedPets.find(p => p.id === petId);
            if (!pet) return;

            selectedPetId = petId;
            const petDisplayName = upgradedPets[pet.item.name] ? pet.item.upgrade.name : pet.item.name;

            document.getElementById('pet-name').textContent = `${pet.item.icon} ${petDisplayName}`;
            
            // Calculate next skill usage
            let nextSkillTime = 'Không xác định';
            if (petIntervals[pet.id]) {
                // Get cooldown information
                let baseCooldown = 0;
                switch (pet.item.name) {
                    case 'Chó': baseCooldown = 15000; break;
                    case 'Bướm Bướm': baseCooldown = 25000; break;
                    case 'Tralala!': baseCooldown = 40000; break;
                    case 'Rồng': baseCooldown = 5000; break;
                    case 'Voi Mamut': baseCooldown = 20000; break;
                    case 'Chuột Xám': baseCooldown = 120000; break;
                    case 'Chuột Hamster': baseCooldown = 150000; break;
                    case 'Khủng Long 3 Sừng': baseCooldown = 60000; break;
                    case 'Chuột Sakura': baseCooldown = 30000; break;
                    default: baseCooldown = 30000; break;
                }
                
                const actualCooldown = pet.cooldownReduction ? 
                    baseCooldown * (pet.item.effect === 'grayMouse' || pet.item.effect === 'hamster' ? 
                        (1 + Math.abs(pet.cooldownReduction) / 100) : 
                        (1 - pet.cooldownReduction / 100)) : baseCooldown;
                nextSkillTime = `${Math.round(actualCooldown / 1000)}s`;
            }

            // Get pet function description
            let functionDescription = '';
            switch (pet.item.effect) {
                case 'seed': functionDescription = 'Mang về hạt giống ngẫu nhiên mỗi 15 giây'; break;
                case 'golden': functionDescription = 'Hóa vàng cây ngẫu nhiên mỗi 25 giây'; break;
                case 'rainbow': functionDescription = 'Hóa cầu vồng cây ngẫu nhiên mỗi 40 giây'; break;
                case 'money': functionDescription = 'Tạo tiền mỗi 5 giây'; break;
                case 'doubleYield': functionDescription = 'Nhân đôi sản lượng cây mỗi 20 giây'; break;
                case 'grayMouse': functionDescription = 'PASSIVE: Cung cấp +0.5 exp/giây cho tất cả thú cưng'; break;
                case 'hamster': functionDescription = 'PASSIVE: Cung cấp +1 exp/giây cho tất cả thú cưng'; break;
                case 'triHornDino': functionDescription = 'Sao chép kỹ năng thú cưng khác mỗi 60 giây'; break;
                case 'sakuraMouse': functionDescription = 'Nhổ nước bọt mỗi 30 giây, tăng exp cho 1-3 thú cưng'; break;
                default: functionDescription = 'Kỹ năng đặc biệt'; break;
            }

            document.getElementById('pet-info').innerHTML = `
                <div><strong>Cấp độ:</strong> ${pet.level || 1}</div>
                <div><strong>Kinh nghiệm:</strong> ${(pet.experience || 0).toFixed(1)}/${(pet.level || 1) * 100}</div>
                <div><strong>Khối lượng:</strong> ${pet.kg || 0}kg</div>
                <div><strong>Giảm cooldown:</strong> ${pet.cooldownReduction ? pet.cooldownReduction.toFixed(1) : 0}%</div>
                ${pet.level >= 5 && !pet.evolved ? '<div class="mt-2 p-2 bg-purple-100 rounded"><strong>🌟 Sẵn sàng tiến hóa!</strong></div>' : ''}
            `;
            
            document.getElementById('pet-function').textContent = functionDescription;
            
            // Show cooldown timer only for active skill pets (not passive pets)
            const passivePets = ['grayMouse', 'hamster', 'tRex'];
            if (passivePets.includes(pet.item.effect)) {
                document.getElementById('pet-next-skill').textContent = 'Kỹ năng thụ động - không có thời gian hồi chiêu';
            } else {
                document.getElementById('pet-next-skill').textContent = `Kỹ năng tiếp theo: ${nextSkillTime}`;
            }
            
            document.getElementById('pet-details-modal').classList.remove('hidden');
            
            // Check for evolution at level 5
            if (pet.level >= 5 && !pet.evolved) {
                setTimeout(() => {
                    showEvolutionModal(pet.id);
                }, 500);
            }
        };

        const closePetDetails = () => {
            document.getElementById('pet-details-modal').classList.add('hidden');
            selectedPetId = null;
        };

        const sellSelectedPet = () => {
            if (!selectedPetId) return;
            evaluatePlant(selectedPetId, 'pet');
            closePetDetails();
        };

        const removePetToInventory = () => {
            if (!selectedPetId) return;
            const pet = plantedPets.find(p => p.id === selectedPetId);
            if (!pet) return;

            // Remove from planted pets
            plantedPets = plantedPets.filter(p => p.id !== selectedPetId);
            
            // Add back to owned pets inventory
            ownedPets.push(pet.item.name);
            
            // Clear pet interval
            if (petIntervals[selectedPetId]) {
                clearInterval(petIntervals[selectedPetId]);
                delete petIntervals[selectedPetId];
            }
            
            addNotification(`${pet.item.name} đã được gỡ ra khỏi vườn!`);
            renderGarden();
            renderInventory();
            saveGameState();
            closePetDetails();
        };

        // Evolution System Functions
        const showEvolutionModal = (petId) => {
            const pet = plantedPets.find(p => p.id === petId);
            if (!pet || pet.level < 5 || pet.evolved) return;
            
            pendingEvolutionPet = petId;
            const petDisplayName = upgradedPets[pet.item.name] ? pet.item.upgrade.name : pet.item.name;
            
            document.getElementById('evolution-pet-info').textContent = 
                `${petDisplayName} Lv.${pet.level} sẵn sàng tiến hóa! Thú cưng sẽ mạnh hơn và bạn sẽ nhận thêm 1 slot vườn (tối đa 6 slots).`;
            
            document.getElementById('evolution-modal').classList.remove('hidden');
        };

        const confirmEvolution = () => {
            if (!pendingEvolutionPet) return;
            
            const pet = plantedPets.find(p => p.id === pendingEvolutionPet);
            if (!pet) return;
            
            // Mark as evolved
            pet.evolved = true;
            pet.level = 6; // Reset to level 6 after evolution
            pet.experience = 0;
            
            // Increase garden slots (max 6)
            if (maxGardenSlots < 6) {
                maxGardenSlots++;
                addNotification(`🌟 ${pet.item.name} đã tiến hóa! Nhận thêm 1 slot vườn (${maxGardenSlots}/6)!`, 'info');
            } else {
                addNotification(`🌟 ${pet.item.name} đã tiến hóa! Thú cưng mạnh hơn!`, 'info');
            }
            
            // Boost pet stats after evolution
            pet.kg = Math.round((pet.kg * 1.5) * 10) / 10; // 50% increase in kg
            
            // Recalculate cooldown reduction
            const kgReduction = pet.kg * 0.02;
            const levelReduction = pet.level * 0.005;
            pet.cooldownReduction = (kgReduction + levelReduction) * 100;
            
            cancelEvolution();
            renderGarden();
            saveGameState();
        };

        const cancelEvolution = () => {
            document.getElementById('evolution-modal').classList.add('hidden');
            pendingEvolutionPet = null;
        };

        // Pet cooldown tracking system
        const updatePetCooldowns = () => {
            plantedPets.forEach(pet => {
                if (pet.cooldownTimer > 0) {
                    pet.cooldownTimer -= 1; // Decrease by 1 second
                }
            });
        };

        window.onload = () => {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('auth-title').textContent = 'Đăng Nhập';
        };
    </script>
</body>
</html>
